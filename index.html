<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MultiAgent‚ÄëRAG Pro v2.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ 'worker' –¥–ª—è pdf.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
  <style> .mono{font-family: ui-monospace, Menlo, Consolas, monospace;} </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">üöÄ MultiAgent‚ÄëRAG Pro v2.0 - –û–ë–ù–û–í–õ–ï–ù–û!</h1>
      <div class="text-xs text-slate-500">API: <code id="apiBase" class="mono text-green-600"></code></div>
    </header>

    <div class="bg-green-100 border border-green-400 p-4 rounded mb-4">
      <h2 class="font-bold text-green-800">‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!</h2>
      <p class="text-sm text-green-700">–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è RAG –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="bg-white rounded-2xl shadow p-4 lg:col-span-1">
        <h2 class="font-semibold mb-2">üß† 1) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏—è–º–∏</h2>
        <div class="mb-3 text-xs bg-blue-50 p-2 rounded">
          <strong>üìä –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:</strong><br/>
          üìÑ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã: <span id="docs_count" class="font-bold text-blue-600">0</span><br/>
          üß† –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏: <span id="entities_count" class="font-bold text-green-600">0</span>
        </div>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç:</label>
            <textarea id="text" class="w-full border rounded-lg p-2 text-sm h-20" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞..."></textarea>
          </div>
          <button onclick="ingestText()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-all duration-200 text-sm transform active:scale-95">
            üìö –î–æ–±–∞–≤–∏—Ç—å + –ò–∑–≤–ª–µ—á—å —Å—É—â–Ω–æ—Å—Ç–∏
          </button>
          <div class="text-xs text-slate-500">
            ‚ú® –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ª—é–¥–µ–π, –∫–æ–º–ø–∞–Ω–∏–∏, –º–µ—Å—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
          </div>
          
          <div class="border-t pt-3 mt-3">
            <label class="block text-sm font-medium mb-1">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞:</label>
            <input type="file" id="file_input" class="w-full text-xs border rounded p-1" accept=".txt,.md,.pdf">
            <div class="text-xs text-slate-500 mt-1">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è .txt, .md, .pdf</div>
            <button onclick="loadFileAsText()" class="w-full mt-2 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 active:bg-gray-800 transition-all duration-200 text-sm transform active:scale-95">
              üìÇ –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª
            </button>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow p-4 lg:col-span-2">
        <h2 class="font-semibold mb-2">ü§ñ 2) –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—ã–π RAG</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">–í–∞—à –≤–æ–ø—Ä–æ—Å:</label>
            <input id="q" class="w-full border rounded-lg p-2 text-sm" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º...">
          </div>
          <button id="askBtn" onclick="ask()" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 active:bg-red-800 transition-all duration-200 text-sm transform active:scale-95">
            üöÄ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å
          </button>
          
          <div id="thinking" class="mt-2 hidden">
            <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
              <div class="flex items-center">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-600 mr-2"></div>
                <span id="thinking_status" class="font-medium">ü§î –°–∏—Å—Ç–µ–º–∞ –¥—É–º–∞–µ—Ç...</span>
              </div>
            </div>
          </div>

          <div class="text-xs space-y-2">
            <div>
              <strong>üìã –ü–ª–∞–Ω:</strong>
              <div id="plan" class="bg-slate-100 p-2 rounded text-xs mono whitespace-pre-wrap"></div>
            </div>
            <div>
              <strong>üí° –û—Ç–≤–µ—Ç:</strong>
              <div id="answer" class="bg-slate-100 p-2 rounded text-xs mono whitespace-pre-wrap"></div>
            </div>
            <div>
              <strong>üîç –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏:</strong>
              <div id="extracted_entities" class="bg-blue-50 p-2 rounded text-xs mono whitespace-pre-wrap"></div>
            </div>
            <div>
              <strong>üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:</strong>
              <ul id="cites" class="mt-1 space-y-1"></ul>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º Railway API
let API = 'https://multiagentragle-production.up.railway.app';

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('api')) {
  API = urlParams.get('api');
}

console.log('üöÄ API URL:', API);
document.getElementById('apiBase').textContent = API;

// –ü—Ä–æ–≤–µ—Ä–∫–∞ API
async function checkAPI() {
  try {
    const response = await fetch(API + '/health');
    if (response.ok) {
      document.getElementById('apiBase').className = 'mono text-green-600 font-bold';
      document.getElementById('apiBase').title = '‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç';
    } else {
      throw new Error('API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
    }
  } catch (error) {
    document.getElementById('apiBase').className = 'mono text-red-600';
    document.getElementById('apiBase').title = '‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ: ' + error.message;
  }
}

checkAPI();

async function ingestText(){
  const text = document.getElementById('text').value || ''; 
  if(!text.trim()) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
  
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  
  try {
    btn.innerHTML = 'üìö –ó–∞–≥—Ä—É–∂–∞—é –¥–æ–∫—É–º–µ–Ω—Ç...';
    const fd1 = new FormData(); 
    fd1.append('text', text); 
    fd1.append('doc_id', 'user_doc_' + Date.now());
    const r1 = await fetch(API + '/ingest/text', {method:'POST', body: fd1});
    
    if (!r1.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞');
    
    btn.innerHTML = 'üß† –ò–∑–≤–ª–µ–∫–∞—é —Å—É—â–Ω–æ—Å—Ç–∏...';
    const fd2 = new FormData();
    fd2.append('text', text);
    fd2.append('task_prompt', '–ò–∑–≤–ª–µ–∫–∏ –ª—é–¥–µ–π, –∫–æ–º–ø–∞–Ω–∏–∏, –º–µ—Å—Ç–∞, —Å–æ–±—ã—Ç–∏—è –∏ –¥–∞—Ç—ã');
    fd2.append('doc_id', 'extracted_' + Date.now());
    
    const r2 = await fetch(API + '/langextract/text', {method:'POST', body: fd2});
    if (r2.ok) {
      const j2 = await r2.json();
      const entitiesCount = j2.items ? j2.items.length : 0;
      document.getElementById('entities_count').textContent = entitiesCount;
    }
    
    btn.innerHTML = '‚úÖ –ì–æ—Ç–æ–≤–æ! –î–æ–∫—É–º–µ–Ω—Ç + —Å—É—â–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã';
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }, 3000);
    
  } catch (error) {
    btn.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }, 3000);
  }
}

async function loadFileAsText() {
  const fileInput = document.getElementById('file_input');
  const btn = event.target;
  const originalHTML = btn.innerHTML;

  if (fileInput.files.length === 0) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.');
    return;
  }
  const file = fileInput.files[0];

  btn.disabled = true;
  btn.innerHTML = 'üîÑ –ß–∏—Ç–∞—é —Ñ–∞–π–ª...';

  try {
    let text = '';
    if (file.type === 'application/pdf') {
      const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
      const pdf = await loadingTask.promise;
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n\n';
      }
      text = fullText;
    } else { // –î–ª—è .txt, .md –∏ –¥—Ä—É–≥–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
      text = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = event => resolve(event.target.result);
        reader.onerror = error => reject(error);
        reader.readAsText(file);
      });
    }

    document.getElementById('text').value = text;
    alert('‚úÖ –¢–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–∞ "' + file.name + '" –∑–∞–≥—Ä—É–∂–µ–Ω! –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å + –ò–∑–≤–ª–µ—á—å —Å—É—â–Ω–æ—Å—Ç–∏".');

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', error);
    alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç (.txt, .md, .pdf) –∏ —Ñ–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }
}

async function ask(){
  const q = document.getElementById('q').value || ''; 
  if(!q.trim()) return alert('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å');
  
  const askBtn = document.getElementById('askBtn');
  const thinking = document.getElementById('thinking');
  const thinkingStatus = document.getElementById('thinking_status');
  
  askBtn.disabled = true;
  askBtn.textContent = 'ü§î –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...';
  thinking.classList.remove('hidden');
  
  // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
  const planEl = document.getElementById('plan');
  const answerEl = document.getElementById('answer');
  const entitiesEl = document.getElementById('extracted_entities');
  const citesEl = document.getElementById('cites');
  
  planEl.textContent = '';
  answerEl.textContent = '';
  entitiesEl.textContent = '';
  citesEl.innerHTML = '';
  
  const ents = document.getElementById('entities')?.value || '';
  const source = new EventSource(API + '/ask/stream?q=' + encodeURIComponent(q) + '&entities=' + encodeURIComponent(ents));

  source.onmessage = function(event) {
    const data = JSON.parse(event.data);
    
    switch (data.type) {
      case 'plan':
        thinkingStatus.textContent = '‚úÖ –ü–ª–∞–Ω –≥–æ—Ç–æ–≤. –ò–∑–≤–ª–µ–∫–∞—é —Å—É—â–Ω–æ—Å—Ç–∏...';
        planEl.textContent = data.data;
        break;
      case 'entities':
        thinkingStatus.textContent = '‚úÖ –°—É—â–Ω–æ—Å—Ç–∏ –∏–∑–≤–ª–µ—á–µ–Ω—ã. –ò—â—É –¥–æ–∫—É–º–µ–Ω—Ç—ã...';
        entitiesEl.textContent = data.data.length > 0 ? 'üéØ –ù–∞–π–¥–µ–Ω–æ: ' + data.data.join(', ') : '‚ùå –°—É—â–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
        break;
      case 'citations':
        thinkingStatus.textContent = '‚úÖ –î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã. –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç–≤–µ—Ç...';
        if (data.data.length > 0) {
          data.data.forEach(c => {
            const li = document.createElement('li');
            li.textContent = 'üìÑ ' + c;
            citesEl.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.textContent = 'üìÑ –ü–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
          citesEl.appendChild(li);
        }
        break;
      case 'answer_chunk':
        answerEl.textContent += data.data;
        break;
      case 'answer_done':
        thinking.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º "–¥—É–º–∞–ª–∫—É"
        source.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        askBtn.disabled = false;
        askBtn.textContent = 'üöÄ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å';
        break;
      case 'error':
        answerEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + data.data;
        thinking.classList.add('hidden');
        source.close();
        askBtn.disabled = false;
        askBtn.textContent = 'üöÄ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å';
        break;
    }
  };

  source.onerror = function(err) {
    console.error("EventSource failed:", err);
    answerEl.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
    thinking.classList.add('hidden');
    source.close();
    askBtn.disabled = false;
    askBtn.textContent = 'üöÄ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å';
  };
}
</script>

</body>
</html>
