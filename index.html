<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MultiAgent‚ÄëRAG Pro v2.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ 'worker' –¥–ª—è pdf.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
  <style> 
    .mono{font-family: ui-monospace, Menlo, Consolas, monospace;} 
    .highlight { background-color: #fefcbf; /* yellow-100 */ }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">üöÄ MultiAgent‚ÄëRAG Pro v2.0 - –û–ë–ù–û–í–õ–ï–ù–û!</h1>
      <div class="text-xs text-slate-500">
          API: 
          <input id="apiInput" placeholder="https://..." class="mono w-64 border rounded px-1 text-xs">
          <button id="apiSave" class="bg-green-500 text-white px-2 py-0.5 rounded text-xs hover:bg-green-600">üíæ</button>
          <button id="apiPing" class="bg-blue-500 text-white px-2 py-0.5 rounded text-xs hover:bg-blue-600">Ping</button>
          <code id="apiEcho" class="mono"></code>
      </div>
    </header>

    <div class="bg-green-100 border border-green-400 p-4 rounded mb-4">
      <h2 class="font-bold text-green-800">‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!</h2>
      <p class="text-sm text-green-700">–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è RAG –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="bg-white rounded-2xl shadow p-4 lg:col-span-1">
        <h2 class="font-semibold mb-2">üß† 1) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏—è–º–∏</h2>
        <div class="mb-3 text-xs bg-blue-50 p-2 rounded">
          <strong>üìä –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:</strong><br/>
          üìÑ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã: <span id="docs_count" class="font-bold text-blue-600">0</span><br/>
          üß† –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏: <span id="entities_count" class="font-bold text-green-600">0</span>
        </div>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç:</label>
            <textarea id="text" class="w-full border rounded-lg p-2 text-sm h-20" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞..."></textarea>
          </div>
          <button onclick="ingestText()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-all duration-200 text-sm transform active:scale-95">
            üìö –î–æ–±–∞–≤–∏—Ç—å + –ò–∑–≤–ª–µ—á—å —Å—É—â–Ω–æ—Å—Ç–∏
          </button>
          <div class="text-xs text-slate-500">
            ‚ú® –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ª—é–¥–µ–π, –∫–æ–º–ø–∞–Ω–∏–∏, –º–µ—Å—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
          </div>
          
          <div class="border-t pt-3 mt-3">
            <label class="block text-sm font-medium mb-1">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞:</label>
            <input type="file" id="file_input" class="w-full text-xs border rounded p-1" accept=".txt,.md,.pdf">
            <div class="text-xs text-slate-500 mt-1">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è .txt, .md, .pdf</div>
            <button onclick="loadFileAsText()" class="w-full mt-2 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 active:bg-gray-800 transition-all duration-200 text-sm transform active:scale-95">
              üìÇ –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª
            </button>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow p-4 lg:col-span-2">
        <h2 class="font-semibold mb-2">ü§ñ 2) –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—ã–π RAG</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">–í–∞—à –≤–æ–ø—Ä–æ—Å:</label>
            <input id="q" class="w-full border rounded-lg p-2 text-sm" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º...">
          </div>
          <button id="askBtn" onclick="ask()" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 active:bg-red-800 transition-all duration-200 text-sm transform active:scale-95">
            üöÄ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å
          </button>
          
          <div id="thinking" class="mt-2 hidden">
            <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
              <div class="flex items-center">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-600 mr-2"></div>
                <span id="thinking_status" class="font-medium">ü§î –°–∏—Å—Ç–µ–º–∞ –¥—É–º–∞–µ—Ç...</span>
              </div>
            </div>
          </div>

          <div class="text-xs space-y-2">
            <div>
              <strong>üìã –ü–ª–∞–Ω:</strong>
              <div id="plan" class="bg-slate-100 p-2 rounded text-xs mono whitespace-pre-wrap"></div>
            </div>
            <div>
              <strong>üí° –û—Ç–≤–µ—Ç:</strong>
              <div id="answer" class="bg-slate-100 p-2 rounded text-xs mono whitespace-pre-wrap"></div>
            </div>
            <div>
              <strong>üîç –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏:</strong>
              <div id="extracted_entities" class="bg-blue-50 p-2 rounded text-xs mono whitespace-pre-wrap"></div>
            </div>
            <div>
              <strong>üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:</strong>
              <ul id="cites" class="mt-1 space-y-1"></ul>
            </div>
            
            <!-- –î–µ—Ç–∞–ª–∏ –æ—Ç–≤–µ—Ç–∞ -->
            <div id="answer-details" class="mt-4 border-t pt-2 hidden">
                <h4 class="font-semibold text-gray-700">–î–µ—Ç–∞–ª–∏ –æ—Ç–≤–µ—Ç–∞:</h4>
                <div class="grid grid-cols-2 gap-x-2 text-gray-600">
                    <div><strong>–¢–∏–ø –ø–æ–∏—Å–∫–∞:</strong> <span id="detail-search-type">...</span></div>
                    <div><strong>–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:</strong> <span id="detail-candidates">...</span></div>
                    <div><strong>Reranker:</strong> <span id="detail-reranker">...</span></div>
                    <div><strong>–ö–æ–Ω—Ç–µ–∫—Å—Ç:</strong> <span id="detail-context-size">...</span></div>
                </div>
            </div>
            
          </div>
        </div>
      </section>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ü–∏—Ç–∞—Ç -->
    <div id="citation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
      <div class="relative top-20 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3 border-b">
          <h3 class="text-lg font-bold">–ò—Å—Ç–æ—á–Ω–∏–∫: <span id="citation-title" class="mono"></span></h3>
          <button id="close-modal-btn" class="text-black close-modal">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div id="citation-content" class="mt-3 max-h-96 overflow-y-auto text-sm" style="white-space: pre-wrap;">
          <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ü–∏—Ç–∞—Ç—ã -->
        </div>
      </div>
    </div>

    <section class="bg-white rounded-2xl shadow p-4 mt-6">
      <h2 class="font-semibold mb-2">üóÑÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ë–∞–∑–æ–π –ó–Ω–∞–Ω–∏–π</h2>
      <div class="flex items-center mb-2">
          <button onclick="fetchDocuments()" class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded transition-all transform active:scale-95">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div id="kb-list-container" class="max-h-64 overflow-y-auto border rounded-lg">
          <table id="kb-table" class="min-w-full text-sm hidden">
              <thead class="bg-gray-50">
                  <tr>
                      <th class="px-4 py-2 text-left font-medium text-gray-600">ID –î–æ–∫—É–º–µ–Ω—Ç–∞</th>
                      <th class="px-4 py-2 text-left font-medium text-gray-600">–ü—Ä–µ–≤—å—é</th>
                      <th class="px-4 py-2 text-left font-medium text-gray-600">–î–ª–∏–Ω–∞</th>
                      <th class="px-4 py-2 text-left font-medium text-gray-600">–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
              </thead>
              <tbody id="kb-list" class="bg-white divide-y divide-gray-200">
                  <!-- Rows will be added here dynamically -->
              </tbody>
          </table>
          <p id="kb-empty-state" class="p-4 text-sm text-gray-500">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</p>
      </div>
    </section>
  </div>

<script>
// --- API URL Management ---
const apiInput = document.getElementById('apiInput');
const apiSave = document.getElementById('apiSave');
const apiPing = document.getElementById('apiPing');
const apiEcho = document.getElementById('apiEcho');

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π URL
const savedApi = localStorage.getItem('apiBase') || 'https://multiagentragle-production.up.railway.app';
const initialApi = new URLSearchParams(location.search).get('api') || savedApi;
apiInput.value = initialApi;
let API = initialApi; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è API
apiEcho.textContent = '...';

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ URL
apiSave.onclick = () => { 
    const newApi = apiInput.value.trim();
    localStorage.setItem('apiBase', newApi); 
    API = newApi;
    apiEcho.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
    setTimeout(() => { apiEcho.textContent = '...'; }, 2000);
    checkAPI(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π URL
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
apiPing.onclick = async () => {
    apiEcho.textContent = 'Pinging...';
    try { 
        const r = await fetch(apiInput.value.trim() + '/health', {cache:'no-store'}); 
        const data = await r.json();
        if (r.ok && data.ok) {
            apiEcho.textContent = `‚úÖ OK (Model: ${data.model})`;
        } else {
            apiEcho.textContent = `‚ùå ERR ${r.status}`;
        }
    } catch(e) { 
        apiEcho.textContent = '‚ùå ERR ' + (e?.message||e); 
    }
};

document.getElementById('apiBase').textContent = API;

// –ü—Ä–æ–≤–µ—Ä–∫–∞ API
async function checkAPI() {
  try {
    const response = await fetch(API + '/health');
    if (response.ok) {
      document.getElementById('apiBase').className = 'mono text-green-600 font-bold';
      document.getElementById('apiBase').title = '‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç';
      apiEcho.textContent = `‚úÖ OK`;
    } else {
      throw new Error('API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
    }
  } catch (error) {
    document.getElementById('apiBase').className = 'mono text-red-600';
    document.getElementById('apiBase').title = '‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ: ' + error.message;
    apiEcho.textContent = `‚ùå ${error.message}`;
  }
}
// --- End API URL Management ---

checkAPI();
fetchDocuments();

async function ingestText(){
  const text = document.getElementById('text').value || ''; 
  if(!text.trim()) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
  
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  
  try {
    btn.innerHTML = 'üìö –ó–∞–≥—Ä—É–∂–∞—é –¥–æ–∫—É–º–µ–Ω—Ç...';
    const fd1 = new FormData(); 
    fd1.append('text', text); 
    fd1.append('doc_id', 'user_doc_' + Date.now());
    const r1 = await fetch(API + '/ingest/text', {method:'POST', body: fd1});
    
    if (!r1.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞');
    
    btn.innerHTML = 'üß† –ò–∑–≤–ª–µ–∫–∞—é —Å—É—â–Ω–æ—Å—Ç–∏...';
    const fd2 = new FormData();
    fd2.append('text', text);
    fd2.append('task_prompt', '–ò–∑–≤–ª–µ–∫–∏ –ª—é–¥–µ–π, –∫–æ–º–ø–∞–Ω–∏–∏, –º–µ—Å—Ç–∞, —Å–æ–±—ã—Ç–∏—è –∏ –¥–∞—Ç—ã');
    fd2.append('doc_id', 'extracted_' + Date.now());
    
    const r2 = await fetch(API + '/langextract/text', {method:'POST', body: fd2});
    if (r2.ok) {
      const j2 = await r2.json();
      const entitiesCount = j2.items ? j2.items.length : 0;
      document.getElementById('entities_count').textContent = entitiesCount;
    }
    
    fetchDocuments(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    
    btn.innerHTML = '‚úÖ –ì–æ—Ç–æ–≤–æ! –î–æ–∫—É–º–µ–Ω—Ç + —Å—É—â–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã';
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }, 3000);
    
  } catch (error) {
    btn.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }, 3000);
  }
}

async function fetchDocuments() {
    try {
        const response = await fetch(API + '/documents');
        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤');

        const documents = await response.json();
        const kbList = document.getElementById('kb-list');
        const kbTable = document.getElementById('kb-table');
        const kbEmptyState = document.getElementById('kb-empty-state');
        kbList.innerHTML = ''; // Clear old list

        if (documents.length > 0) {
            kbTable.classList.remove('hidden');
            kbEmptyState.classList.add('hidden');
            documents.forEach(doc => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap font-mono text-xs">${doc.doc_id}</td>
                    <td class="px-4 py-2 text-gray-500 truncate" style="max-width: 300px;" title="${doc.text_preview}">${doc.text_preview}</td>
                    <td class="px-4 py-2 whitespace-nowrap">${doc.text_length}</td>
                    <td class="px-4 py-2 whitespace-nowrap">
                        <button onclick="deleteDocument('${doc.doc_id}')" class="text-red-600 hover:text-red-900 text-xs font-medium">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                `;
                kbList.appendChild(row);
            });
        } else {
            kbTable.classList.add('hidden');
            kbEmptyState.classList.remove('hidden');
        }
        
        // Update the count in the ingest panel
        document.getElementById('docs_count').textContent = documents.length;

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:', error);
    }
}

async function deleteDocument(docId) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç "${docId}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) {
        return;
    }
    try {
        const response = await fetch(`${API}/documents/${docId}`, {
            method: 'DELETE',
        });

        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç');
        
        console.log(`–î–æ–∫—É–º–µ–Ω—Ç ${docId} —É–¥–∞–ª–µ–Ω.`);
        fetchDocuments(); // Refresh the list after deleting
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç: ' + error.message);
    }
}

async function loadFileAsText() {
  const fileInput = document.getElementById('file_input');
  const btn = event.target;
  const originalHTML = btn.innerHTML;

  if (fileInput.files.length === 0) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.');
    return;
  }
  const file = fileInput.files[0];

  btn.disabled = true;
  btn.innerHTML = 'üîÑ –ß–∏—Ç–∞—é —Ñ–∞–π–ª...';

  try {
    let text = '';
    if (file.type === 'application/pdf') {
      const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
      const pdf = await loadingTask.promise;
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n\n';
      }
      text = fullText;
    } else { // –î–ª—è .txt, .md –∏ –¥—Ä—É–≥–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
      text = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = event => resolve(event.target.result);
        reader.onerror = error => reject(error);
        reader.readAsText(file);
      });
    }

    document.getElementById('text').value = text;
    alert('‚úÖ –¢–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–∞ "' + file.name + '" –∑–∞–≥—Ä—É–∂–µ–Ω! –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å + –ò–∑–≤–ª–µ—á—å —Å—É—â–Ω–æ—Å—Ç–∏".');

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', error);
    alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç (.txt, .md, .pdf) –∏ —Ñ–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
let currentHits = [];

async function ask(){
  const q = document.getElementById('q').value || ''; 
  if(!q.trim()) return alert('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å');
  
  const askBtn = document.getElementById('askBtn');
  const thinking = document.getElementById('thinking');
  const thinkingStatus = document.getElementById('thinking_status');
  
  askBtn.disabled = true;
  askBtn.textContent = 'ü§î –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...';
  thinking.classList.remove('hidden');
  
  // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
  const planEl = document.getElementById('plan');
  const answerEl = document.getElementById('answer');
  const entitiesEl = document.getElementById('extracted_entities');
  const citesEl = document.getElementById('cites');
  const detailsEl = document.getElementById('answer-details');
  
  planEl.textContent = '';
  answerEl.textContent = '';
  entitiesEl.textContent = '';
  citesEl.innerHTML = '';
  detailsEl.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
  
  currentHits = []; // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ö–∏—Ç—ã
  
  const ents = document.getElementById('entities')?.value || '';
  const source = new EventSource(API + '/ask/stream?q=' + encodeURIComponent(q) + '&entities=' + encodeURIComponent(ents));

  source.onmessage = function(event) {
    const data = JSON.parse(event.data);
    
    switch (data.type) {
      case 'plan':
        thinkingStatus.textContent = '‚úÖ –ü–ª–∞–Ω –≥–æ—Ç–æ–≤. –ò–∑–≤–ª–µ–∫–∞—é —Å—É—â–Ω–æ—Å—Ç–∏...';
        planEl.textContent = data.data;
        break;
      case 'entities':
        thinkingStatus.textContent = '‚úÖ –°—É—â–Ω–æ—Å—Ç–∏ –∏–∑–≤–ª–µ—á–µ–Ω—ã. –ò—â—É –¥–æ–∫—É–º–µ–Ω—Ç—ã...';
        entitiesEl.textContent = data.data.length > 0 ? 'üéØ –ù–∞–π–¥–µ–Ω–æ: ' + data.data.join(', ') : '‚ùå –°—É—â–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
        break;
      case 'citations':
        thinkingStatus.textContent = '‚úÖ –î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã. –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç–≤–µ—Ç...';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö–∏—Ç—ã –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        currentHits = data.hits || [];
        
        const citations = data.citations || [];
        if (citations.length > 0) {
          citations.forEach(chunkId => {
            const li = document.createElement('li');
            const button = document.createElement('button');
            button.className = 'text-blue-600 hover:underline mono text-xs';
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º ID –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const docId = chunkId.split('_chunk_')[0];
            const chunkNum = chunkId.split('_chunk_').pop();
            button.textContent = `üìÑ ${docId} (Chunk: ${chunkNum})`;
            
            button.onclick = () => showCitationModal(chunkId);
            li.appendChild(button);
            citesEl.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.textContent = 'üìÑ –ü–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
          citesEl.appendChild(li);
        }
        break;
      case 'search_details':
        document.getElementById('detail-search-type').textContent = data.data.search_type;
        document.getElementById('detail-candidates').textContent = data.data.candidates_found;
        break;
      case 'rerank_details':
        document.getElementById('detail-reranker').textContent = `‚úÖ ${data.data.reranker_model}`;
        document.getElementById('detail-context-size').textContent = `${data.data.final_context_chunks} —á–∞–Ω–∫–æ–≤`;
        break;
      case 'answer_chunk':
        answerEl.textContent += data.data;
        break;
      case 'answer_done':
        thinking.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º "–¥—É–º–∞–ª–∫—É"
        detailsEl.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
        source.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        askBtn.disabled = false;
        askBtn.textContent = 'üöÄ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å';
        break;
      case 'error':
        answerEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + data.data;
        thinking.classList.add('hidden');
        detailsEl.classList.add('hidden');
        source.close();
        askBtn.disabled = false;
        askBtn.textContent = 'üöÄ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å';
        break;
    }
  };

  source.onerror = function(err) {
    console.error("EventSource failed:", err);
    answerEl.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
    thinking.classList.add('hidden');
    detailsEl.classList.add('hidden');
    source.close();
    askBtn.disabled = false;
    askBtn.textContent = 'üöÄ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å';
  };
}

function showCitationModal(docId) { // docId –∑–¥–µ—Å—å - —ç—Ç–æ chunkId
    const hit = currentHits.find(h => h.doc_id === docId);
    if (!hit) {
        alert('–¢–µ–∫—Å—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. ID: ' + docId);
        return;
    }

    const modal = document.getElementById('citation-modal');
    const title = document.getElementById('citation-title');
    const content = document.getElementById('citation-content');
    const query = document.getElementById('q').value;

    title.textContent = docId;

    // –ü—Ä–æ—Å—Ç–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–ª–æ–≤ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
    let highlightedText = hit.text_content;
    const queryWords = query.split(/\s+/).filter(w => w.length > 2); // –ë–µ—Ä–µ–º —Å–ª–æ–≤–∞ –¥–ª–∏–Ω–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤
    queryWords.forEach(word => {
        const regex = new RegExp(`(${word})`, 'gi');
        highlightedText = highlightedText.replace(regex, '<span class="highlight">$1</span>');
    });

    content.innerHTML = highlightedText;
    modal.classList.remove('hidden');
}

document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('citation-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    
    const closeModal = () => modal.classList.add('hidden');
    
    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
});

async function fetchDocuments() {
    try {
        const response = await fetch(API + '/documents');
        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤');

        const documents = await response.json();
        const kbList = document.getElementById('kb-list');
        const kbTable = document.getElementById('kb-table');
        const kbEmptyState = document.getElementById('kb-empty-state');
        kbList.innerHTML = ''; // Clear old list

        if (documents.length > 0) {
            kbTable.classList.remove('hidden');
            kbEmptyState.classList.add('hidden');
            documents.forEach(doc => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap font-mono text-xs">${doc.doc_id}</td>
                    <td class="px-4 py-2 text-gray-500 truncate" style="max-width: 300px;" title="${doc.text_preview}">${doc.text_preview}</td>
                    <td class="px-4 py-2 whitespace-nowrap">${doc.text_length}</td>
                    <td class="px-4 py-2 whitespace-nowrap">
                        <button onclick="deleteDocument('${doc.doc_id}')" class="text-red-600 hover:text-red-900 text-xs font-medium">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                `;
                kbList.appendChild(row);
            });
        } else {
            kbTable.classList.add('hidden');
            kbEmptyState.classList.remove('hidden');
        }
        
        // Update the count in the ingest panel
        document.getElementById('docs_count').textContent = documents.length;

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:', error);
    }
}
</script>

</body>
</html>
