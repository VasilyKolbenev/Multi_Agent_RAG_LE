<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MultiAgent‚ÄëRAG Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> .mono{font-family: ui-monospace, Menlo, Consolas, monospace;} </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">MultiAgent‚ÄëRAG Pro</h1>
      <div class="text-xs text-slate-500">API: <code id="apiBase" class="mono"></code></div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="bg-white rounded-2xl shadow p-4 lg:col-span-1">
        <h2 class="font-semibold mb-2">1) –ò–Ω–∂–µ—Å—Ç</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">–¢–µ–∫—Å—Ç:</label>
            <textarea id="text" class="w-full border rounded-lg p-2 text-sm h-20" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç..."></textarea>
          </div>
          <button onclick="ingestText()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–ø—É—Å</button>
          <div>
            <label class="block text-sm font-medium mb-1">–ü—É—Ç—å –∫ –ø–∞–ø–∫–µ:</label>
            <input id="folder" class="w-full border rounded-lg p-2 text-sm" placeholder="data/docs" value="data/docs">
            <button onclick="ingestFolder()" class="w-full mt-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–ø–∫—É</button>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow p-4 lg:col-span-1">
        <h2 class="font-semibold mb-2">2) –ü–æ–∏—Å–∫</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">–ó–∞–ø—Ä–æ—Å:</label>
            <input id="q" class="w-full border rounded-lg p-2 text-sm" placeholder="–ü–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º...">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">–°—É—â–Ω–æ—Å—Ç–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
            <input id="entities" class="w-full border rounded-lg p-2 text-sm" placeholder="person, company, event">
          </div>
          <button onclick="search()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm">–ù–∞–π—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>
          <div class="text-xs text-slate-500">
            <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong>
            <ul id="hits" class="mt-1 space-y-1"></ul>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow p-4 lg:col-span-1">
        <h2 class="font-semibold mb-2">3) –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—ã–π RAG</h2>
        <div class="space-y-3">
          <button onclick="ask()" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</button>
          <div id="thinking" class="mt-2 hidden">
            <div class="bg-yellow-50 border border-yellow-200 rounded p-2 text-xs">
              <div class="flex items-center">
                <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-yellow-600 mr-2"></div>
                <span id="thinking_status">–°–∏—Å—Ç–µ–º–∞ –¥—É–º–∞–µ—Ç...</span>
              </div>
            </div>
          </div>
          <div class="text-xs">
            <div class="mb-2">
              <strong>–ü–ª–∞–Ω:</strong>
              <div id="plan" class="bg-slate-100 p-2 rounded text-xs mono whitespace-pre-wrap"></div>
            </div>
            <div class="mb-2">
              <strong>–û—Ç–≤–µ—Ç:</strong>
              <div id="answer" class="bg-slate-100 p-2 rounded text-xs mono whitespace-pre-wrap"></div>
            </div>
            <div class="mb-2">
              <strong>–ö—Ä–∏—Ç–∏–∫–∞:</strong>
              <div id="critique" class="bg-slate-100 p-2 rounded text-xs mono whitespace-pre-wrap"></div>
            </div>
            <div class="mb-2">
              <strong>–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏:</strong>
              <div id="extracted_entities" class="bg-blue-50 p-2 rounded text-xs mono whitespace-pre-wrap"></div>
            </div>
            <div>
              <strong>–¶–∏—Ç–∞—Ç—ã:</strong>
              <ul id="cites" class="mt-1 space-y-1"></ul>
            </div>
          </div>
        </div>
      </section>
    </div>

    <section class="bg-white rounded-2xl shadow p-4 mt-6">
      <h2 class="font-semibold mb-2">4) LangExtract</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">–¢–µ–∫—Å—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:</label>
          <textarea id="lx_text" class="w-full border rounded-lg p-2 text-sm h-32" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π..."></textarea>
          <div class="mt-2">
            <label class="block text-sm font-medium mb-1">–ü—Ä–æ–º–ø—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
            <input id="lx_prompt" class="w-full border rounded-lg p-2 text-sm" placeholder="–ò–∑–≤–ª–µ–∫–∏ –ª—é–¥–µ–π, –∫–æ–º–ø–∞–Ω–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è">
          </div>
          <div class="flex gap-2 mt-2">
            <button onclick="runLEText()" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">–ò–∑–≤–ª–µ—á—å —Å—É—â–Ω–æ—Å—Ç–∏</button>
            <button onclick="runLETextStream()" class="flex-1 bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 text-sm">–°—Ç—Ä–∏–º</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">–†–µ–∑—É–ª—å—Ç–∞—Ç:</label>
          <pre id="lx_out" class="w-full bg-slate-100 border rounded-lg p-2 text-xs mono h-48 overflow-auto whitespace-pre-wrap"></pre>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow p-4 mt-6">
      <h2 class="font-semibold mb-2">5) –ü—Ä–æ—Ñ–∏–ª–∏</h2>
      <div id="profiles" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <footer class="mt-6 text-center text-xs text-slate-500">
      <p>MultiAgent-RAG Pro | Powered by OpenAI GPT-5-mini</p>
      <p class="mt-1">üìö <strong>–°–∏—Å—Ç–µ–º–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</strong></p>
      <p class="mt-1">üîç –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Üí –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã ‚Üí –ü–æ–ª—É—á–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã —Å —Ü–∏—Ç–∞—Ç–∞–º–∏</p>
      <p class="mt-1">‚ö†Ô∏è –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±—ç–∫–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É API</p>
    </footer>
  </div>

<script>
// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ URL API
let API = 'http://localhost:8000';

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('api')) {
  API = urlParams.get('api');
} else if (window.API_BASE) {
  API = window.API_BASE;
} else if (window.location.hostname.includes('github.io')) {
  // –î–ª—è GitHub Pages - –∏—Å–ø–æ–ª—å–∑—É–µ–º Railway URL
  API = 'https://multiagentragle-production.up.railway.app';
}

document.getElementById('apiBase').textContent = API;

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
async function checkAPI() {
  try {
    const response = await fetch(API + '/health');
    if (response.ok) {
      document.getElementById('apiBase').className = 'mono text-green-600';
      document.getElementById('apiBase').title = 'API –¥–æ—Å—Ç—É–ø–Ω–æ';
    } else {
      throw new Error('API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
    }
  } catch (error) {
    document.getElementById('apiBase').className = 'mono text-red-600';
    document.getElementById('apiBase').title = 'API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ: ' + error.message;
  }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
checkAPI();

async function ingestText(){
  const text = document.getElementById('text').value || ''; if(!text.trim()) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
  const fd = new FormData(); fd.append('text', text); fd.append('doc_id', 'user_doc_' + Date.now());
  const r = await fetch(API + '/ingest/text', {method:'POST', body: fd});
  const j = await r.json(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
}

async function ingestFolder(){
  const path = document.getElementById('folder').value || 'data/docs';
  const fd = new FormData(); fd.append('path', path);
  const r = await fetch(API + '/ingest/folder', {method:'POST', body: fd});
  const j = await r.json(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
}

async function search(){
  const q = document.getElementById('q').value || ''; const ents = document.getElementById('entities').value || '';
  const r = await fetch(API + '/search?q=' + encodeURIComponent(q) + '&entities=' + encodeURIComponent(ents));
  const j = await r.json(); const ul = document.getElementById('hits'); ul.innerHTML = '';
  j.forEach(h=>{ const li=document.createElement('li'); li.textContent=h.doc_id + ' (score ' + h.score.toFixed(2)+')'; ul.appendChild(li); });
}
async function ask(){
  const q = document.getElementById('q').value || ''; 
  if(!q.trim()) return alert('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å');
  
  const ents = document.getElementById('entities').value || '';
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –º—ã—à–ª–µ–Ω–∏—è
  const thinking = document.getElementById('thinking');
  const thinkingStatus = document.getElementById('thinking_status');
  thinking.classList.remove('hidden');
  
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  document.getElementById('plan').textContent = '';
  document.getElementById('answer').textContent = '';
  document.getElementById('critique').textContent = '';
  document.getElementById('extracted_entities').textContent = '';
  document.getElementById('cites').innerHTML = '';
  
  try {
    thinkingStatus.textContent = 'üîç –ò–∑–≤–ª–µ–∫–∞—é —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ –≤–æ–ø—Ä–æ—Å–∞...';
    await new Promise(resolve => setTimeout(resolve, 500));
    
    thinkingStatus.textContent = 'üìö –ò—â—É —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã...';
    await new Promise(resolve => setTimeout(resolve, 500));
    
    thinkingStatus.textContent = 'ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç–≤–µ—Ç —Å –ø–æ–º–æ—â—å—é –ò–ò...';
    
    const r = await fetch(API + '/ask?q=' + encodeURIComponent(q) + '&entities=' + encodeURIComponent(ents));
    const j = await r.json();
    
    thinking.classList.add('hidden');
    
    document.getElementById('plan').textContent = j.plan || '';
    document.getElementById('answer').textContent = j.answer || '';
    document.getElementById('critique').textContent = j.critique || '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
    const extractedEntities = j.extracted_entities || [];
    document.getElementById('extracted_entities').textContent = extractedEntities.length > 0 ? 
      'üéØ –ù–∞–π–¥–µ–Ω–æ: ' + extractedEntities.join(', ') : '‚ùå –°—É—â–Ω–æ—Å—Ç–∏ –Ω–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã';
    
    const ul = document.getElementById('cites'); ul.innerHTML = '';
    (j.citations || []).forEach(c => { const li=document.createElement('li'); li.textContent='üìÑ ' + c; ul.appendChild(li); });
    
  } catch (error) {
    thinking.classList.add('hidden');
    alert('–û—à–∏–±–∫–∞: ' + error.message);
  }
}

async function runLEText(){
  const text = document.getElementById('lx_text').value || ''; const prompt = document.getElementById('lx_prompt').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  const fd = new FormData(); fd.append('text', text); fd.append('task_prompt', prompt); fd.append('doc_id','demo_doc');
  const r = await fetch(API + '/langextract/text', {method:'POST', body: fd}); const j = await r.json();
  document.getElementById('lx_out').textContent = JSON.stringify(j.items.slice(0,20), null, 2);
  window.open(API + '/extracts/' + j.job_id + '/viz.html', '_blank');
}

async function runLETextStream(){
  const text = document.getElementById('lx_text').value || ''; const prompt = document.getElementById('lx_prompt').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  const fd = new FormData(); fd.append('text', text); fd.append('task_prompt', prompt);
  const r = await fetch(API + '/langextract/text/stream', {method:'POST', body: fd});
  if(!r.body) return alert('–°—Ç—Ä–∏–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
  const reader = r.body.getReader(); const decoder = new TextDecoder();
  let buffer = ''; document.getElementById('lx_out').textContent = '';
  while(true){
    const {done, value} = await reader.read(); if(done) break;
    buffer += decoder.decode(value, {stream: true});
    const lines = buffer.split('\n');
    buffer = lines.pop();
    for(const line of lines){
      if(line.startsWith('data: ')){
        const data = line.slice(6).trim();
        if(data && data !== '[DONE]'){
          try{ const obj = JSON.parse(data); document.getElementById('lx_out').textContent += JSON.stringify(obj, null, 2) + '\n'; }catch(e){}
        }
      }
    }
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π
async function loadProfiles(){
  try {
    const r = await fetch(API + '/profiles');
    const profiles = await r.json();
    const container = document.getElementById('profiles');
    container.innerHTML = '';
    profiles.forEach(profile => {
      const div = document.createElement('div');
      div.className = 'bg-slate-100 p-3 rounded-lg';
      div.innerHTML = `
        <h3 class="font-medium text-sm">${profile.name}</h3>
        <p class="text-xs text-slate-600 mt-1">${profile.description}</p>
        <button onclick="useProfile('${profile.id}')" class="mt-2 w-full bg-slate-600 text-white px-3 py-1 rounded text-xs hover:bg-slate-700">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
      `;
      container.appendChild(div);
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π:', error);
  }
}

async function useProfile(profileId) {
  try {
    const r = await fetch(API + '/profiles/' + profileId);
    const profile = await r.json();
    document.getElementById('q').value = profile.example_query || '';
    document.getElementById('entities').value = profile.entities ? profile.entities.join(', ') : '';
    alert('–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω: ' + profile.name);
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
  }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
loadProfiles();
</script>

</body>
</html>
