<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üöÄ MultiAgent‚ÄëRAG Pro v4.0 - AGENTIC RAG!</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> .mono{font-family: ui-monospace, Menlo, Consolas, monospace;} </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-bold">üöÄ MultiAgent‚ÄëRAG Pro</h1>
        <div class="text-xs text-emerald-600 font-medium">
                     ‚úÖ v4.0 - AGENTIC RAG! | üïê –û–±–Ω–æ–≤–ª–µ–Ω–æ: 2024-12-19 22:00
        </div>
      </div>
      <div class="text-right">
        <div class="text-xs text-slate-500">API: <code id="apiBase" class="mono"></code></div>
        <div class="text-xs text-slate-400" id="buildInfo">Build: AUTO-UPDATE-20250904</div>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="bg-white rounded-2xl shadow p-4 lg:col-span-1">
        <h2 class="font-semibold mb-2">1) –ò–Ω–∂–µ—Å—Ç</h2>
        <div class="space-y-3">
          <div>
            <label class="text-sm block mb-1">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç</label>
            <input id="title" class="w-full border rounded px-2 py-1 mb-1" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞">
            <textarea id="text" rows="4" class="w-full border rounded px-2 py-1" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
            <button class="mt-2 px-3 py-1.5 rounded bg-indigo-600 text-white" onclick="ingestTextWithEntities()">üìö –î–æ–±–∞–≤–∏—Ç—å + –ò–∑–≤–ª–µ—á—å —Å—É—â–Ω–æ—Å—Ç–∏</button>
          </div>
          <div>
            <label class="text-sm block mb-1">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã (txt/md/pdf)</label>
            <input id="files" type="file" multiple class="w-full border rounded px-2 py-1">
            <button class="mt-2 px-3 py-1.5 rounded bg-indigo-600 text-white" onclick="ingestFiles()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          </div>
          <div class="text-xs text-slate-500">–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞: <input id="folder" class="border rounded px-2 py-1" placeholder="data/docs"> <button class="px-2 py-1 rounded bg-slate-800 text-white" onclick="ingestFolder()">–ò–º–ø–æ—Ä—Ç –ø–∞–ø–∫–∏</button></div>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow p-4 lg:col-span-2">
        <h2 class="font-semibold mb-2">2) –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</h2>
        
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
        <div class="mb-4 p-3 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-slate-700">üéØ –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</span>
            <div class="flex items-center space-x-3">
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="ragMode" value="classic" checked class="mr-2" onchange="updateModeDescription()">
                <span class="text-sm">üîß Classic RAG</span>
              </label>
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="ragMode" value="agentic" class="mr-2" onchange="updateModeDescription()">
                <span class="text-sm">üöÄ Agentic RAG</span>
              </label>
            </div>
          </div>
          <div id="modeDescription" class="text-xs text-slate-600">
            Classic: –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–±—ã—Å—Ç—Ä–æ)
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-2 mb-2">
          <input id="q" class="border rounded px-3 py-2 lg:col-span-2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò—Ç–æ–≥–∏ –∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ ACME">
          <input id="entities" class="border rounded px-3 py-2" placeholder="–§–∏–ª—å—Ç—Ä —Å—É—â–Ω–æ—Å—Ç–µ–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
        </div>
        <div class="flex gap-2 mb-3">
          <button class="px-4 py-2 rounded bg-emerald-600 text-white" onclick="askIntelligent()">üöÄ –£–º–Ω—ã–π –ø–æ–∏—Å–∫</button>
          <button class="px-4 py-2 rounded bg-slate-600 text-white" onclick="ask()">üîß Classic</button>
          <button class="px-4 py-2 rounded bg-slate-800 text-white" onclick="search()">–ü–æ–∏—Å–∫</button>
        </div>
        
        <!-- Agentic RAG Process Visualization -->
        <div id="agenticProcess" class="mb-4 hidden">
          <div class="bg-slate-50 rounded-lg p-3 border">
            <h3 class="text-sm font-medium text-slate-700 mb-2">ü§ñ –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤:</h3>
            <div id="agentSteps" class="space-y-2"></div>
            <div class="mt-2 flex items-center">
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <span id="progressText" class="ml-2 text-xs text-slate-600">0%</span>
            </div>
          </div>
        </div>
        <div id="out" class="space-y-4">
          <div class="p-3 rounded bg-slate-100"><div class="text-xs text-slate-500">–ü–ª–∞–Ω</div><pre id="plan" class="mono text-sm whitespace-pre-wrap"></pre></div>
          <div class="p-3 rounded bg-slate-100"><div class="text-xs text-slate-500">–û—Ç–≤–µ—Ç</div><div id="answer" class="prose max-w-none"></div></div>
          <div class="p-3 rounded bg-slate-100"><div class="text-xs text-slate-500">–ö—Ä–∏—Ç–∏–∫–∞</div><pre id="critique" class="mono text-sm whitespace-pre-wrap"></pre></div>
          <div class="p-3 rounded bg-slate-100"><div class="text-xs text-slate-500">–ò—Å—Ç–æ—á–Ω–∏–∫–∏</div><ul id="cites" class="list-disc pl-5 text-sm"></ul></div>
          <div class="p-3 rounded bg-slate-100"><div class="text-xs text-slate-500">–ú–∞—Ç—á–∏ –ø–æ–∏—Å–∫–∞</div><ul id="hits" class="list-disc pl-5 text-sm"></ul></div>
        </div>
      </section>
    </div>

    <section class="mt-6 bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-2">3) –ü—Ä–æ—Ñ–∏–ª–∏ –∑–∞–¥–∞—á</h2>
      <div class="text-sm text-slate-600 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å ‚Äî –ø–æ–¥—Å—Ç–∞–≤–∏–º –ø—Ä–æ–º–ø—Ç LangExtract –∏ –ø—Ä–∏–º–µ—Ä—ã.</div>
      <div class="flex gap-2 mb-3">
        <select id="profile" class="border rounded px-2 py-2"></select>
        <button class="px-3 py-2 rounded bg-violet-600 text-white" onclick="applyProfile()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
      <textarea id="lx_prompt" rows="4" class="w-full border rounded px-2 py-1" placeholder="–ü—Ä–æ–º–ø—Ç –¥–ª—è LangExtract"></textarea>
    </section>

    <!-- –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ -->
    <section class="mt-6 bg-white rounded-2xl shadow p-4" id="entitiesSection" style="display:none;">
      <h2 class="font-semibold mb-3">üîç –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
        <div class="bg-blue-50 p-3 rounded-lg text-center">
          <div class="text-2xl font-bold text-blue-600" id="orgCount">0</div>
          <div class="text-sm text-blue-600">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</div>
        </div>
        <div class="bg-green-50 p-3 rounded-lg text-center">
          <div class="text-2xl font-bold text-green-600" id="personCount">0</div>
          <div class="text-sm text-green-600">–ü–µ—Ä—Å–æ–Ω—ã</div>
        </div>
        <div class="bg-purple-50 p-3 rounded-lg text-center">
          <div class="text-2xl font-bold text-purple-600" id="dateCount">0</div>
          <div class="text-sm text-purple-600">–î–∞—Ç—ã</div>
        </div>
        <div class="bg-orange-50 p-3 rounded-lg text-center">
          <div class="text-2xl font-bold text-orange-600" id="moneyCount">0</div>
          <div class="text-sm text-orange-600">–î–µ–Ω—å–≥–∏</div>
        </div>
      </div>
      <div class="space-y-3">
        <div>
          <h3 class="text-sm font-medium text-blue-700 mb-2">üè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h3>
          <div id="orgEntities" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-green-700 mb-2">üë§ –ü–µ—Ä—Å–æ–Ω—ã</h3>
          <div id="personEntities" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-purple-700 mb-2">üìÖ –î–∞—Ç—ã</h3>
          <div id="dateEntities" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-orange-700 mb-2">üí∞ –î–µ–Ω—å–≥–∏</h3>
          <div id="moneyEntities" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">üîó –î—Ä—É–≥–∏–µ</h3>
          <div id="otherEntities" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </section>

    <section class="mt-6 bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-2">4) LangExtract: –∑–∞–ø—É—Å–∫ –∏ —Å—Ç—Ä–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <label class="text-sm block mb-1">–¢–µ–∫—Å—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è</label>
          <textarea id="lx_text" rows="6" class="w-full border rounded px-2 py-1" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
          <div class="flex gap-2 mt-2">
            <button class="px-3 py-1.5 rounded bg-violet-600 text-white" onclick="runLETextWithDisplay()">üîç –ò–∑–≤–ª–µ—á—å —Å—É—â–Ω–æ—Å—Ç–∏</button>
            <button class="px-3 py-1.5 rounded bg-violet-800 text-white" onclick="runLETextStream()">–°—Ç—Ä–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
          </div>
        </div>
        <div>
          <div class="text-xs text-slate-500 mb-1">–°—Ç–∞—Ç—É—Å</div>
          <ul id="progress" class="text-sm space-y-1"></ul>
          <div class="mt-2 text-xs text-slate-500">–ü–µ—Ä–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</div>
          <pre id="lx_out" class="mono text-sm whitespace-pre-wrap"></pre>
        </div>
      </div>
    </section>
  </div>

<script>
const API = new URLSearchParams(location.search).get('api') || (window.API_BASE || 'https://multiagentragle-production.up.railway.app');
// –î–æ–±–∞–≤–ª—è–µ–º cache buster –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
const CACHE_BUSTER = '?v=2.1-langextract-fix-' + Date.now();
console.log('üîß API Base URL:', API);
document.getElementById('apiBase').textContent = API;

let PROFILES = [];
async function loadProfiles(){
  const r = await fetch(API + '/profiles'); PROFILES = await r.json();
  const sel = document.getElementById('profile'); sel.innerHTML = '';
  PROFILES.forEach(p => { const o = document.createElement('option'); o.value=p.id; o.textContent=p.title; sel.appendChild(o); });
}
function applyProfile(){
  const id = document.getElementById('profile').value;
  const p = PROFILES.find(x=>x.id===id); if(!p) return;
  document.getElementById('lx_prompt').value = p.prompt || '';
  alert('–ü—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏–º–µ–Ω—ë–Ω: ' + p.title);
}

async function ingestText(){
  const title = document.getElementById('title').value || 'doc';
  const text = document.getElementById('text').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  const fd = new FormData(); fd.append('title', title); fd.append('text', text);
  const r = await fetch(API + '/ingest/text', {method:'POST', body: fd});
  const j = await r.json(); alert('OK: ' + j.doc_id);
}
async function ingestFiles(){
  const files = document.getElementById('files').files; if(!files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã');
  const fd = new FormData(); for(const f of files) fd.append('files', f);
  const r = await fetch(API + '/ingest/files', {method:'POST', body: fd}); const j = await r.json(); alert('–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ' + j.count);
}
async function ingestFolder(){
  const path = document.getElementById('folder').value || 'data/docs';
  const fd = new FormData(); fd.append('path', path);
  const r = await fetch(API + '/ingest/folder', {method:'POST', body: fd});
  const j = await r.json(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
}

async function search(){
  const q = document.getElementById('q').value || ''; const ents = document.getElementById('entities').value || '';
  const r = await fetch(API + '/search?q=' + encodeURIComponent(q) + '&entities=' + encodeURIComponent(ents));
  const j = await r.json(); const ul = document.getElementById('hits'); ul.innerHTML = '';
  j.forEach(h=>{ const li=document.createElement('li'); li.textContent=h.doc_id + ' (score ' + h.score.toFixed(2)+')'; ul.appendChild(li); });
}
async function ask(){
  const q = document.getElementById('q').value || ''; const ents = document.getElementById('entities').value || '';
  const r = await fetch(API + '/ask?q=' + encodeURIComponent(q) + '&entities=' + encodeURIComponent(ents));
  const j = await r.json();
  document.getElementById('plan').textContent = j.plan || '';
  document.getElementById('answer').textContent = j.answer || '';
  document.getElementById('critique').textContent = j.critique || '';
  const ul = document.getElementById('cites'); ul.innerHTML = '';
  (j.citations || []).forEach(c => { const li=document.createElement('li'); li.textContent=c; ul.appendChild(li); });
}

async function runLEText(){
  const text = document.getElementById('lx_text').value || ''; const prompt = document.getElementById('lx_prompt').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  const fd = new FormData(); fd.append('text', text); fd.append('task_prompt', prompt); fd.append('doc_id','demo_doc');
  const r = await fetch(API + '/langextract/text', {method:'POST', body: fd}); const j = await r.json();
  document.getElementById('lx_out').textContent = JSON.stringify(j.items.slice(0,20), null, 2);
  window.open(API + '/extracts/' + j.job_id + '/viz.html', '_blank');
}

async function runLETextStream(){
  const text = document.getElementById('lx_text').value || ''; const prompt = document.getElementById('lx_prompt').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  const list = document.getElementById('progress'); list.innerHTML='';
  function push(msg){ const li=document.createElement('li'); li.textContent=msg; list.appendChild(li); }
  const es = new EventSource(API + '/langextract/stream_text?text=' + encodeURIComponent(text) + '&task_prompt=' + encodeURIComponent(prompt) + '&doc_id=demo_doc');
  es.onmessage = (e)=>{
    try{
      const ev = JSON.parse(e.data);
      if(ev.event==='done'){ document.getElementById('lx_out').textContent = JSON.stringify(ev.result.items.slice(0,20), null, 2); window.open(API + '/extracts/' + ev.result.job_id + '/viz.html', '_blank'); es.close(); push('–ì–æ—Ç–æ–≤–æ'); }
      else{ push(ev.event + (ev.msg?': '+ev.msg:'')); }
    }catch(err){ console.error(err); }
  };
  es.onerror = (e)=>{ push('–û—à–∏–±–∫–∞ —Å—Ç—Ä–∏–º–∞'); es.close(); };
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π
function displayEntities(entities) {
  if (!entities || entities.length === 0) {
    document.getElementById('entitiesSection').style.display = 'none';
    return;
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é
  document.getElementById('entitiesSection').style.display = 'block';

  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—É—â–Ω–æ—Å—Ç–∏ –ø–æ —Ç–∏–ø–∞–º
  const groups = {
    organization: [],
    person: [],
    date: [],
    money: [],
    other: []
  };

  entities.forEach(entity => {
    const type = entity.class ? entity.class.toLowerCase() : 'other';
    if (groups[type]) {
      groups[type].push(entity);
    } else {
      groups.other.push(entity);
    }
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
  document.getElementById('orgCount').textContent = groups.organization.length;
  document.getElementById('personCount').textContent = groups.person.length;
  document.getElementById('dateCount').textContent = groups.date.length;
  document.getElementById('moneyCount').textContent = groups.money.length;

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å—É—â–Ω–æ—Å—Ç–∏
  function createEntityElement(entity, colorClass) {
    const span = document.createElement('span');
    span.className = `px-3 py-1 rounded-full text-sm cursor-pointer hover:opacity-80 transition-opacity ${colorClass}`;
    span.textContent = entity.text;
    span.title = `–¢–∏–ø: ${entity.class || 'unknown'}`;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
    if (entity.attributes && Object.keys(entity.attributes).length > 0) {
      span.title += `\n–ê—Ç—Ä–∏–±—É—Ç—ã: ${JSON.stringify(entity.attributes)}`;
    }
    
    // –ö–ª–∏–∫ –ø–æ —Å—É—â–Ω–æ—Å—Ç–∏ - –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    span.onclick = () => {
      document.getElementById('entities').value = entity.text;
      document.getElementById('q').focus();
    };
    
    return span;
  }

  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—É—â–Ω–æ—Å—Ç–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º
  const containers = {
    organization: document.getElementById('orgEntities'),
    person: document.getElementById('personEntities'),
    date: document.getElementById('dateEntities'),
    money: document.getElementById('moneyEntities'),
    other: document.getElementById('otherEntities')
  };

  const colors = {
    organization: 'bg-blue-100 text-blue-800 border border-blue-200',
    person: 'bg-green-100 text-green-800 border border-green-200',
    date: 'bg-purple-100 text-purple-800 border border-purple-200',
    money: 'bg-orange-100 text-orange-800 border border-orange-200',
    other: 'bg-gray-100 text-gray-800 border border-gray-200'
  };

  // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
  Object.values(containers).forEach(container => container.innerHTML = '');

  // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
  Object.keys(groups).forEach(type => {
    const container = containers[type];
    const entities = groups[type];
    
    if (entities.length === 0) {
      container.innerHTML = '<span class="text-gray-400 text-sm">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</span>';
    } else {
      entities.forEach(entity => {
        container.appendChild(createEntityElement(entity, colors[type]));
      });
    }
  });
}

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é ingestText —á—Ç–æ–±—ã –æ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ —Å—É—â–Ω–æ—Å—Ç–∏
async function ingestTextWithEntities(){
  const title = document.getElementById('title').value || 'doc';
  const text = document.getElementById('text').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  
  // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
  const fd1 = new FormData(); 
  fd1.append('doc_id', title); 
  fd1.append('text', text);
  const r1 = await fetch(API + '/ingest/text', {method:'POST', body: fd1});
  const j1 = await r1.json();
  
  // –ó–∞—Ç–µ–º –∏–∑–≤–ª–µ–∫–∞–µ–º —Å—É—â–Ω–æ—Å—Ç–∏
  const fd2 = new FormData(); 
  fd2.append('text', text); 
  fd2.append('task_prompt', document.getElementById('lx_prompt').value || ''); 
  fd2.append('doc_id', title);
  const r2 = await fetch(API + '/langextract/text', {method:'POST', body: fd2}); 
  const j2 = await r2.json();
  
  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—É—â–Ω–æ—Å—Ç–∏
  displayEntities(j2.items || []);
  
  alert(`‚úÖ –î–æ–∫—É–º–µ–Ω—Ç "${title}" –¥–æ–±–∞–≤–ª–µ–Ω!\nüîç –ò–∑–≤–ª–µ—á–µ–Ω–æ ${j2.items ? j2.items.length : 0} —Å—É—â–Ω–æ—Å—Ç–µ–π`);
}

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é runLEText —á—Ç–æ–±—ã –æ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ —Å—É—â–Ω–æ—Å—Ç–∏
async function runLETextWithDisplay(){
  const text = document.getElementById('lx_text').value || ''; 
  const prompt = document.getElementById('lx_prompt').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  
  const fd = new FormData(); 
  fd.append('text', text); 
  fd.append('task_prompt', prompt); 
  fd.append('doc_id','demo_doc');
  const r = await fetch(API + '/langextract/text', {method:'POST', body: fd}); 
  const j = await r.json();
  
  document.getElementById('lx_out').textContent = JSON.stringify(j.items.slice(0,20), null, 2);
  displayEntities(j.items || []);
  window.open(API + '/extracts/' + j.job_id + '/viz.html', '_blank');
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º API
function showVersionInfo() {
  const now = new Date();
  const buildTime = now.toLocaleString('ru-RU');
  document.getElementById('buildInfo').textContent = `Build: AUTO-UPDATE-20250904${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  const header = document.querySelector('header');
  const updateBadge = document.createElement('div');
  updateBadge.className = 'fixed top-4 right-4 bg-emerald-500 text-white px-3 py-1 rounded-full text-xs font-medium shadow-lg z-50 animate-pulse';
  updateBadge.textContent = 'üÜï –û–±–Ω–æ–≤–ª–µ–Ω–æ!';
  document.body.appendChild(updateBadge);
  
  // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    updateBadge.style.opacity = '0';
    updateBadge.style.transition = 'opacity 1s';
    setTimeout(() => updateBadge.remove(), 1000);
  }, 5000);
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
async function checkAPIStatus() {
  try {
    const response = await fetch(API + '/health');
    const data = await response.json();
    if (data.ok) {
      console.log('‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω, –º–æ–¥–µ–ª—å:', data.model || 'unknown');
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤ header
      const statusDiv = document.createElement('div');
      statusDiv.className = 'text-xs text-emerald-600';
      statusDiv.innerHTML = `üü¢ API Online | Model: ${data.model || 'unknown'}`;
      document.getElementById('apiBase').parentElement.appendChild(statusDiv);
    }
  } catch (error) {
    console.log('‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error.message);
    const statusDiv = document.createElement('div');
    statusDiv.className = 'text-xs text-red-600';
    statusDiv.innerHTML = 'üî¥ API Offline';
    document.getElementById('apiBase').parentElement.appendChild(statusDiv);
  }
}

// === AGENTIC RAG FUNCTIONS ===

function updateModeDescription() {
  const selectedMode = document.querySelector('input[name="ragMode"]:checked').value;
  const description = document.getElementById('modeDescription');
  
  if (selectedMode === 'classic') {
    description.innerHTML = 'Classic: –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–±—ã—Å—Ç—Ä–æ, ~10 —Å–µ–∫)';
  } else {
    description.innerHTML = 'Agentic: –£–º–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç, –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É—é—Ç, –∏—â—É—Ç –ª—É—á—à–∏–π –æ—Ç–≤–µ—Ç (–º–µ–¥–ª–µ–Ω–Ω–µ–µ, ~30-60 —Å–µ–∫)';
  }
}

async function askIntelligent() {
  const selectedMode = document.querySelector('input[name="ragMode"]:checked').value;
  
  if (selectedMode === 'classic') {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π RAG
    await ask();
  } else {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Agentic RAG
    await askAgentic();
  }
}

async function askAgentic() {
  const q = document.getElementById('q').value.trim();
  if (!q) {
    alert('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å');
    return;
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤
  const processDiv = document.getElementById('agenticProcess');
  const stepsDiv = document.getElementById('agentSteps');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  
  processDiv.classList.remove('hidden');
  stepsDiv.innerHTML = '';
  progressBar.style.width = '0%';
  progressText.textContent = '0%';
  
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  document.getElementById('plan').textContent = '';
  document.getElementById('answer').innerHTML = '';
  document.getElementById('critique').textContent = '';
  document.getElementById('cites').innerHTML = '';
  document.getElementById('hits').innerHTML = '';
  
  try {
    const url = `${API}/ask/agentic/stream?q=${encodeURIComponent(q)}&max_iterations=5`;
    const eventSource = new EventSource(url);
    
    let currentStep = 0;
    const totalSteps = 5; // Router, Retrieval, Evaluation, Query Rewrite, Synthesis
    
    eventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);
        console.log('Agentic event:', data);
        
        switch(data.type) {
          case 'agentic_start':
            addAgentStep('üöÄ –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã', `–ú–∞–∫—Å–∏–º—É–º –∏—Ç–µ—Ä–∞—Ü–∏–π: ${data.data.max_iterations}`, 'text-blue-600');
            updateProgress(10);
            break;
            
          case 'iteration_start':
            addAgentStep(`üîÑ –ò—Ç–µ—Ä–∞—Ü–∏—è ${data.data.iteration}`, `–ó–∞–ø—Ä–æ—Å: "${data.data.current_query.substring(0, 50)}..."`, 'text-purple-600');
            updateProgress(20 + (data.data.iteration - 1) * 15);
            break;
            
          case 'strategy_selected':
            addAgentStep('üéØ Router Agent', `–í—ã–±—Ä–∞–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: ${data.data.strategy}`, 'text-green-600');
            break;
            
          case 'search_completed':
            const searchData = data.data;
            addAgentStep('üîç Retrieval Agent', 
              `${searchData.strategy}: ${searchData.results_count} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${(searchData.relevance_score * 100).toFixed(1)}%`, 
              'text-indigo-600');
            break;
            
          case 'evaluation':
            const evalData = data.data;
            const evalColor = evalData.decision === 'sufficient' ? 'text-green-600' : 'text-orange-600';
            addAgentStep('üìä Evaluation Agent', `–†–µ—à–µ–Ω–∏–µ: ${evalData.decision} - ${evalData.reason}`, evalColor);
            break;
            
          case 'query_rewritten':
            addAgentStep('‚úèÔ∏è Query Rewriter', `–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: "${data.data.new_query.substring(0, 50)}..."`, 'text-yellow-600');
            break;
            
          case 'synthesis_start':
            addAgentStep('üîÑ Synthesis Agent', `–°–∏–Ω—Ç–µ–∑ –æ—Ç–≤–µ—Ç–∞ –∏–∑ ${data.data.total_results} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤`, 'text-blue-600');
            updateProgress(85);
            break;
            
          case 'agentic_complete':
            const result = data.data;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            document.getElementById('answer').innerHTML = result.answer || '–û—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω';
            
            if (result.citations) {
              const citesList = document.getElementById('cites');
              result.citations.forEach(cite => {
                const li = document.createElement('li');
                li.textContent = cite;
                citesList.appendChild(li);
              });
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
            if (result.agentic_metadata) {
              const metadata = result.agentic_metadata;
              addAgentStep('üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–æ', 
                `–í—Ä–µ–º—è: ${metadata.total_time.toFixed(1)}—Å, –∏—Ç–µ—Ä–∞—Ü–∏–π: ${metadata.iterations_used}, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ${metadata.strategies_tried.join(', ')}`, 
                'text-green-700 font-medium');
            }
            
            updateProgress(100);
            eventSource.close();
            break;
            
          case 'agentic_error':
            addAgentStep('‚ùå –û—à–∏–±–∫–∞', data.data, 'text-red-600');
            eventSource.close();
            break;
        }
      } catch (e) {
        console.error('Error parsing agentic event:', e);
      }
    };
    
    eventSource.onerror = function(event) {
      console.error('Agentic EventSource error:', event);
      addAgentStep('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', '–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'text-red-600');
      eventSource.close();
    };
    
  } catch (error) {
    console.error('Agentic RAG error:', error);
    addAgentStep('‚ùå –û—à–∏–±–∫–∞', error.message, 'text-red-600');
  }
}

function addAgentStep(title, description, colorClass) {
  const stepsDiv = document.getElementById('agentSteps');
  const stepDiv = document.createElement('div');
  stepDiv.className = `flex items-start space-x-2 p-2 rounded ${colorClass} bg-white border-l-4 border-current`;
  stepDiv.innerHTML = `
    <div class="flex-1">
      <div class="font-medium text-sm">${title}</div>
      <div class="text-xs opacity-75">${description}</div>
    </div>
    <div class="text-xs opacity-50">${new Date().toLocaleTimeString()}</div>
  `;
  stepsDiv.appendChild(stepDiv);
  
  // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —à–∞–≥—É
  stepDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function updateProgress(percentage) {
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  
  progressBar.style.width = `${percentage}%`;
  progressText.textContent = `${Math.round(percentage)}%`;
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
showVersionInfo();
checkAPIStatus();
loadProfiles();
updateModeDescription();
</script>
</body>
</html>
