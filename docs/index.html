<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üöÄ MultiAgent‚ÄëRAG Pro v4.6 - OPTIMIZED & CLEAN!</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> .mono{font-family: ui-monospace, Menlo, Consolas, monospace;} </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-bold">üöÄ MultiAgent‚ÄëRAG Pro</h1>
        <div class="text-xs text-emerald-600 font-medium">
                     ‚úÖ v4.6.1 - UI BUTTON FIX! | üïê –û–±–Ω–æ–≤–ª–µ–Ω–æ: 2024-12-20 00:10
        </div>
      </div>
      <div class="text-right">
      <div class="text-xs text-slate-500">API: <code id="apiBase" class="mono"></code></div>
        <div class="text-xs text-slate-400" id="buildInfo">Build: AUTO-UPDATE-20250904</div>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="bg-white rounded-2xl shadow p-4 lg:col-span-1">
        <h2 class="font-semibold mb-2">1) –ò–Ω–∂–µ—Å—Ç</h2>
        <div class="space-y-3">
          <div>
            <label class="text-sm block mb-1">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç</label>
            <input id="title" class="w-full border rounded px-2 py-1 mb-1" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞">
            <textarea id="text" rows="4" class="w-full border rounded px-2 py-1" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
            <button class="mt-2 px-3 py-1.5 rounded bg-indigo-600 text-white" onclick="ingestTextWithEntities()">üìö –î–æ–±–∞–≤–∏—Ç—å + –ò–∑–≤–ª–µ—á—å —Å—É—â–Ω–æ—Å—Ç–∏</button>
          </div>
          <div>
            <label class="text-sm block mb-2 font-medium">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π</label>
            <div class="flex items-stretch gap-3 mb-3">
              <input id="files" type="file" multiple accept=".txt,.md,.pdf,.doc,.docx,.rtf,.csv,.json,.xml,.html" class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
              <button class="px-6 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 active:bg-indigo-800 transition-colors font-medium text-sm whitespace-nowrap flex-shrink-0 shadow-sm" onclick="ingestFilesWithFeedback()">
                üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å
              </button>
          </div>
            <div class="text-xs text-slate-600 bg-blue-50 p-2 rounded">
              üí° <strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</strong> TXT, MD, PDF, DOC, DOCX, RTF, CSV, JSON, XML, HTML<br>
              üöÄ <strong>–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:</strong> –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è ‚Üí –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è —Ç–µ–∫—Å—Ç ‚Üí –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è ‚Üí –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å —á–µ—Ä–µ–∑ Agentic RAG
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow p-4 lg:col-span-2">
        <h2 class="font-semibold mb-2">2) –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</h2>
        
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
        <div class="mb-4 p-3 bg-gradient-to-r from-emerald-50 to-blue-50 rounded-lg border">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-slate-700">üéØ –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</span>
            <div class="flex items-center space-x-3">
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="ragMode" value="agentic" checked class="mr-2" onchange="updateModeDescription()">
                <span class="text-sm font-medium">üöÄ Agentic RAG</span>
              </label>
            </div>
          </div>
          <div id="modeDescription" class="text-xs text-slate-600">
            Agentic: –£–º–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã –ø–ª–∞–Ω–∏—Ä—É—é—Ç, –∏—â—É—Ç –∏ —Å–∏–Ω—Ç–µ–∑–∏—Ä—É—é—Ç –æ—Ç–≤–µ—Ç (–º–µ–¥–ª–µ–Ω–Ω–æ, –Ω–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ)
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-2 mb-2">
          <input id="q" class="border rounded px-3 py-2 lg:col-span-2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò—Ç–æ–≥–∏ –∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ ACME">
          <div class="relative">
            <input id="entities" class="border rounded px-3 py-2 w-full" placeholder="–§–∏–ª—å—Ç—Ä —Å—É—â–Ω–æ—Å—Ç–µ–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
            <button class="absolute right-2 top-1/2 transform -translate-y-1/2 text-blue-600 hover:text-blue-700" onclick="showEntitySuggestions()" title="–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏">
              üè∑Ô∏è
            </button>
          </div>
        </div>
        <div class="flex gap-2 mb-3">
          <button class="px-6 py-3 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition-colors font-medium text-lg" onclick="askIntelligent()" title="–£–º–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç –∏ –æ—Ç–≤–µ—á–∞—é—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å">
            üöÄ –£–º–Ω—ã–π –æ—Ç–≤–µ—Ç
          </button>
          <button class="px-4 py-3 rounded-lg bg-orange-600 text-white hover:bg-orange-700 transition-colors font-medium" onclick="search()" title="–ù–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞">
            üîç –ù–∞–π—Ç–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã
          </button>
          <button class="px-4 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors font-medium" onclick="searchByEntities()" title="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∞–º, –∫–æ–º–ø–∞–Ω–∏—è–º, –º–µ—Å—Ç–∞–º">
            üè∑Ô∏è –ü–æ —Å—É—â–Ω–æ—Å—Ç—è–º
          </button>
        </div>
        
        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ –∫–Ω–æ–ø–∫–∞—Ö -->
        <div class="mb-4 text-xs text-slate-600 bg-slate-50 p-2 rounded">
          üí° <strong>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:</strong> 
          üöÄ <strong>–£–º–Ω—ã–π –æ—Ç–≤–µ—Ç</strong> - –∞–≥–µ–Ω—Ç—ã –¥—É–º–∞—é—Ç –∏ –¥–∞—é—Ç –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç | 
          üîç <strong>–ù–∞–π—Ç–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã</strong> - —Ç–æ–ª—å–∫–æ –ø–æ–∏—Å–∫ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ | 
          üè∑Ô∏è <strong>–ü–æ —Å—É—â–Ω–æ—Å—Ç—è–º</strong> - –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∞–º –∏ –∫–æ–º–ø–∞–Ω–∏—è–º
        </div>
        
        <!-- Entity Suggestions Dropdown -->
        <div id="entitySuggestions" class="hidden mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium text-blue-800">üè∑Ô∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π</h3>
            <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="hideEntitySuggestions()">‚úï</button>
          </div>
          <div id="entityCloud" class="flex flex-wrap gap-2">
            <div class="text-sm text-blue-600">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π...</div>
          </div>
        </div>
        
        <!-- Agentic RAG Process Visualization -->
        <div id="agenticProcess" class="mb-4 hidden">
          <div class="bg-slate-50 rounded-lg p-3 border">
            <h3 class="text-sm font-medium text-slate-700 mb-2">ü§ñ –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤:</h3>
            <div id="agentSteps" class="space-y-2"></div>
            <div class="mt-2 flex items-center">
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <span id="progressText" class="ml-2 text-xs text-slate-600">0%</span>
            </div>
          </div>
        </div>
        <div id="out" class="space-y-4">
          <div class="p-3 rounded bg-slate-100"><div class="text-xs text-slate-500">–ü–ª–∞–Ω</div><pre id="plan" class="mono text-sm whitespace-pre-wrap"></pre></div>
          <div class="p-3 rounded bg-slate-100"><div class="text-xs text-slate-500">–û—Ç–≤–µ—Ç</div><div id="answer" class="prose max-w-none"></div></div>
          <div class="p-3 rounded bg-slate-100"><div class="text-xs text-slate-500">–ö—Ä–∏—Ç–∏–∫–∞</div><pre id="critique" class="mono text-sm whitespace-pre-wrap"></pre></div>
          <div class="p-3 rounded bg-slate-100"><div class="text-xs text-slate-500">–ò—Å—Ç–æ—á–Ω–∏–∫–∏</div><ul id="cites" class="list-disc pl-5 text-sm"></ul></div>
          <div class="p-3 rounded bg-slate-100"><div class="text-xs text-slate-500">–ú–∞—Ç—á–∏ –ø–æ–∏—Å–∫–∞</div><ul id="hits" class="list-disc pl-5 text-sm"></ul></div>
        </div>
      </section>
    </div>


    <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π -->
    <section class="mt-6 bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π</h2>
        <button class="px-3 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700 transition-colors" onclick="refreshKnowledgeAnalytics()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
          <div class="text-2xl font-bold text-blue-600" id="totalEntities">0</div>
          <div class="text-sm text-blue-700">–í—Å–µ–≥–æ —Å—É—â–Ω–æ—Å—Ç–µ–π</div>
        </div>
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
          <div class="text-2xl font-bold text-green-600" id="totalDocuments">0</div>
          <div class="text-sm text-green-700">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑–µ</div>
        </div>
        <div class="bg-gradient-to-r from-purple-50 to-violet-50 p-4 rounded-lg border border-purple-200">
          <div class="text-2xl font-bold text-purple-600" id="topEntityType">-</div>
          <div class="text-sm text-purple-700">–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
        </div>
      </div>
      
      <div class="mb-4">
        <h3 class="text-sm font-medium text-slate-700 mb-2">üè∑Ô∏è –û–±–ª–∞–∫–æ —Å—É—â–Ω–æ—Å—Ç–µ–π (–∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø–æ–∏—Å–∫–∞)</h3>
        <div id="knowledgeEntityCloud" class="flex flex-wrap gap-2 p-3 bg-slate-50 rounded-lg min-h-[100px]">
          <div class="text-sm text-slate-500">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π...</div>
        </div>
      </div>
    </section>

    <!-- –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ -->
    <section class="mt-6 bg-white rounded-2xl shadow p-4" id="entitiesSection" style="display:none;">
      <h2 class="font-semibold mb-3">üîç –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
        <div class="bg-blue-50 p-3 rounded-lg text-center">
          <div class="text-2xl font-bold text-blue-600" id="orgCount">0</div>
          <div class="text-sm text-blue-600">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</div>
        </div>
        <div class="bg-green-50 p-3 rounded-lg text-center">
          <div class="text-2xl font-bold text-green-600" id="personCount">0</div>
          <div class="text-sm text-green-600">–ü–µ—Ä—Å–æ–Ω—ã</div>
        </div>
        <div class="bg-purple-50 p-3 rounded-lg text-center">
          <div class="text-2xl font-bold text-purple-600" id="dateCount">0</div>
          <div class="text-sm text-purple-600">–î–∞—Ç—ã</div>
        </div>
        <div class="bg-orange-50 p-3 rounded-lg text-center">
          <div class="text-2xl font-bold text-orange-600" id="moneyCount">0</div>
          <div class="text-sm text-orange-600">–î–µ–Ω—å–≥–∏</div>
        </div>
      </div>
      <div class="space-y-3">
        <div>
          <h3 class="text-sm font-medium text-blue-700 mb-2">üè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h3>
          <div id="orgEntities" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-green-700 mb-2">üë§ –ü–µ—Ä—Å–æ–Ω—ã</h3>
          <div id="personEntities" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-purple-700 mb-2">üìÖ –î–∞—Ç—ã</h3>
          <div id="dateEntities" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-orange-700 mb-2">üí∞ –î–µ–Ω—å–≥–∏</h3>
          <div id="moneyEntities" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">üîó –î—Ä—É–≥–∏–µ</h3>
          <div id="otherEntities" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </section>

    <section class="mt-6 bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold mb-2">3) LangExtract: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è LangExtract -->
          <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
            <label class="text-sm block mb-2 font-medium">üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</label>
            <input id="lx_file" type="file" accept=".txt,.md,.pdf,.doc,.docx,.rtf,.csv,.json,.xml,.html" class="w-full border rounded px-2 py-1 mb-2">
            <button class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors text-sm" onclick="loadFileForLangExtract()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∏–∑–≤–ª–µ—á—å</button>
          </div>
          
          <!-- –ò–ª–∏ –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –≤—Ä—É—á–Ω—É—é -->
          <div class="mb-2">
            <label class="text-sm block mb-1 font-medium">‚úçÔ∏è –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é</label>
            <textarea id="lx_text" rows="6" class="w-full border rounded px-2 py-1" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π..."></textarea>
          </div>
          
          <!-- –ü—Ä–æ–º–ø—Ç –¥–ª—è LangExtract -->
          <div class="mb-3">
            <label class="text-sm block mb-1 font-medium">üéØ –ü—Ä–æ–º–ø—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <textarea id="lx_prompt" rows="2" class="w-full border rounded px-2 py-1 text-sm" placeholder="–ò–∑–≤–ª–µ–∫–∏ –ª—é–¥–µ–π, –∫–æ–º–ø–∞–Ω–∏–∏, –º–µ—Å—Ç–∞, —Å–æ–±—ã—Ç–∏—è –∏ –¥–∞—Ç—ã –∏–∑ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞"></textarea>
          </div>
          <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è LangExtract -->
          <div id="langextractProgress" class="hidden mt-3 mb-3">
            <div class="bg-gradient-to-r from-violet-50 to-purple-50 rounded-lg p-3 border border-violet-200">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-violet-700">üß† LangExtract –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç...</span>
                <div class="flex items-center">
                  <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-violet-600"></div>
                  <span id="langextractTimer" class="ml-2 text-xs text-violet-600">0s</span>
                </div>
              </div>
              <div class="w-full bg-violet-200 rounded-full h-2">
                <div id="langextractBar" class="bg-violet-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
              <div id="langextractStatus" class="text-xs text-violet-600 mt-1">–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞...</div>
            </div>
          </div>
          
          <div class="flex gap-2 mt-2">
            <button id="extractBtn" class="px-3 py-1.5 rounded bg-violet-600 text-white hover:bg-violet-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" onclick="runLETextWithAnimation()">üîç –ò–∑–≤–ª–µ—á—å —Å—É—â–Ω–æ—Å—Ç–∏</button>
            <button id="streamBtn" class="px-3 py-1.5 rounded bg-violet-800 text-white hover:bg-violet-900 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" onclick="runLETextStream()">üì° –°—Ç—Ä–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
          </div>
        </div>
        <div>
          <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
          <div class="mb-3">
            <div class="flex border-b border-slate-200">
              <button id="tabStatus" class="px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600" onclick="switchLangExtractTab('status')">üìä –°—Ç–∞—Ç—É—Å</button>
              <button id="tabText" class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700" onclick="switchLangExtractTab('text')">üìÑ –¢–µ–∫—Å—Ç</button>
              <button id="tabResults" class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700" onclick="switchLangExtractTab('results')">üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            </div>
          </div>
          
          <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
          <div id="statusTab" class="tab-content">
            <div class="text-xs text-slate-500 mb-1">–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏:</div>
            <ul id="progress" class="text-sm space-y-1 bg-slate-50 p-3 rounded min-h-[100px]"></ul>
          </div>
          
          <div id="textTab" class="tab-content hidden">
            <div class="text-xs text-slate-500 mb-1">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</div>
            <div id="loadedText" class="text-sm bg-slate-50 p-3 rounded min-h-[200px] whitespace-pre-wrap overflow-y-auto max-h-[300px]">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ç–µ–∫—Å—Ç –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞...</div>
          </div>
          
          <div id="resultsTab" class="tab-content hidden">
            <div class="text-xs text-slate-500 mb-1">–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏:</div>
            <pre id="lx_out" class="mono text-sm whitespace-pre-wrap bg-slate-50 p-3 rounded min-h-[100px]"></pre>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
const API = new URLSearchParams(location.search).get('api') || (window.API_BASE || 'https://multiagentragle-production.up.railway.app');
// –î–æ–±–∞–≤–ª—è–µ–º cache buster –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
const CACHE_BUSTER = '?v=2.1-langextract-fix-' + Date.now();
console.log('üîß API Base URL:', API);
document.getElementById('apiBase').textContent = API;

let PROFILES = [];
async function loadProfiles(){
  const r = await fetch(API + '/profiles'); PROFILES = await r.json();
  const sel = document.getElementById('profile'); sel.innerHTML = '';
  PROFILES.forEach(p => { const o = document.createElement('option'); o.value=p.id; o.textContent=p.title; sel.appendChild(o); });
}
function applyProfile(){
  const id = document.getElementById('profile').value;
  const p = PROFILES.find(x=>x.id===id); if(!p) return;
  document.getElementById('lx_prompt').value = p.prompt || '';
  alert('–ü—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏–º–µ–Ω—ë–Ω: ' + p.title);
}

async function ingestText(){
  const title = document.getElementById('title').value || 'doc';
  const text = document.getElementById('text').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  const fd = new FormData(); fd.append('title', title); fd.append('text', text);
  const r = await fetch(API + '/ingest/text', {method:'POST', body: fd});
  const j = await r.json(); alert('OK: ' + j.doc_id);
}
async function ingestFiles(){
  const files = document.getElementById('files').files; if(!files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã');
  const fd = new FormData(); for(const f of files) fd.append('files', f);
  const r = await fetch(API + '/ingest/files', {method:'POST', body: fd}); const j = await r.json(); alert('–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ' + j.count);
}
async function ingestFolder(){
  const path = document.getElementById('folder').value || 'data/docs';
  const fd = new FormData(); fd.append('path', path);
  const r = await fetch(API + '/ingest/folder', {method:'POST', body: fd});
  const j = await r.json(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
}

async function search(){
  const q = document.getElementById('q').value || ''; const ents = document.getElementById('entities').value || '';
  const r = await fetch(API + '/search?q=' + encodeURIComponent(q) + '&entities=' + encodeURIComponent(ents));
  const j = await r.json(); const ul = document.getElementById('hits'); ul.innerHTML = '';
  j.forEach(h=>{ const li=document.createElement('li'); li.textContent=h.doc_id + ' (score ' + h.score.toFixed(2)+')'; ul.appendChild(li); });
}
async function ask(){
  const q = document.getElementById('q').value || ''; const ents = document.getElementById('entities').value || '';
  const r = await fetch(API + '/ask?q=' + encodeURIComponent(q) + '&entities=' + encodeURIComponent(ents));
  const j = await r.json();
  document.getElementById('plan').textContent = j.plan || '';
  document.getElementById('answer').textContent = j.answer || '';
  document.getElementById('critique').textContent = j.critique || '';
  const ul = document.getElementById('cites'); ul.innerHTML = '';
  (j.citations || []).forEach(c => { const li=document.createElement('li'); li.textContent=c; ul.appendChild(li); });
}

async function runLEText(){
  const text = document.getElementById('lx_text').value || ''; const prompt = document.getElementById('lx_prompt').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  const fd = new FormData(); fd.append('text', text); fd.append('task_prompt', prompt); fd.append('doc_id','demo_doc');
  const r = await fetch(API + '/langextract/text', {method:'POST', body: fd}); const j = await r.json();
  document.getElementById('lx_out').textContent = JSON.stringify(j.items.slice(0,20), null, 2);
  window.open(API + '/extracts/' + j.job_id + '/viz.html', '_blank');
}

async function runLETextStream(){
  const text = document.getElementById('lx_text').value || ''; const prompt = document.getElementById('lx_prompt').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  const list = document.getElementById('progress'); list.innerHTML='';
  function push(msg){ const li=document.createElement('li'); li.textContent=msg; list.appendChild(li); }
  const es = new EventSource(API + '/langextract/stream_text?text=' + encodeURIComponent(text) + '&task_prompt=' + encodeURIComponent(prompt) + '&doc_id=demo_doc');
  es.onmessage = (e)=>{
    try{
      const ev = JSON.parse(e.data);
      if(ev.event==='done'){ document.getElementById('lx_out').textContent = JSON.stringify(ev.result.items.slice(0,20), null, 2); window.open(API + '/extracts/' + ev.result.job_id + '/viz.html', '_blank'); es.close(); push('–ì–æ—Ç–æ–≤–æ'); }
      else{ push(ev.event + (ev.msg?': '+ev.msg:'')); }
    }catch(err){ console.error(err); }
  };
  es.onerror = (e)=>{ push('–û—à–∏–±–∫–∞ —Å—Ç—Ä–∏–º–∞'); es.close(); };
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π
function displayEntities(entities) {
  if (!entities || entities.length === 0) {
    document.getElementById('entitiesSection').style.display = 'none';
    return;
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é
  document.getElementById('entitiesSection').style.display = 'block';

  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—É—â–Ω–æ—Å—Ç–∏ –ø–æ —Ç–∏–ø–∞–º
  const groups = {
    organization: [],
    person: [],
    date: [],
    money: [],
    other: []
  };

  entities.forEach(entity => {
    const type = entity.class ? entity.class.toLowerCase() : 'other';
    if (groups[type]) {
      groups[type].push(entity);
    } else {
      groups.other.push(entity);
    }
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
  document.getElementById('orgCount').textContent = groups.organization.length;
  document.getElementById('personCount').textContent = groups.person.length;
  document.getElementById('dateCount').textContent = groups.date.length;
  document.getElementById('moneyCount').textContent = groups.money.length;

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å—É—â–Ω–æ—Å—Ç–∏
  function createEntityElement(entity, colorClass) {
    const span = document.createElement('span');
    span.className = `px-3 py-1 rounded-full text-sm cursor-pointer hover:opacity-80 transition-opacity ${colorClass}`;
    span.textContent = entity.text;
    span.title = `–¢–∏–ø: ${entity.class || 'unknown'}`;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
    if (entity.attributes && Object.keys(entity.attributes).length > 0) {
      span.title += `\n–ê—Ç—Ä–∏–±—É—Ç—ã: ${JSON.stringify(entity.attributes)}`;
    }
    
    // –ö–ª–∏–∫ –ø–æ —Å—É—â–Ω–æ—Å—Ç–∏ - –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    span.onclick = () => {
      document.getElementById('entities').value = entity.text;
      document.getElementById('q').focus();
    };
    
    return span;
  }

  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—É—â–Ω–æ—Å—Ç–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º
  const containers = {
    organization: document.getElementById('orgEntities'),
    person: document.getElementById('personEntities'),
    date: document.getElementById('dateEntities'),
    money: document.getElementById('moneyEntities'),
    other: document.getElementById('otherEntities')
  };

  const colors = {
    organization: 'bg-blue-100 text-blue-800 border border-blue-200',
    person: 'bg-green-100 text-green-800 border border-green-200',
    date: 'bg-purple-100 text-purple-800 border border-purple-200',
    money: 'bg-orange-100 text-orange-800 border border-orange-200',
    other: 'bg-gray-100 text-gray-800 border border-gray-200'
  };

  // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
  Object.values(containers).forEach(container => container.innerHTML = '');

  // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
  Object.keys(groups).forEach(type => {
    const container = containers[type];
    const entities = groups[type];
    
    if (entities.length === 0) {
      container.innerHTML = '<span class="text-gray-400 text-sm">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</span>';
    } else {
      entities.forEach(entity => {
        container.appendChild(createEntityElement(entity, colors[type]));
      });
    }
  });
}

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é ingestText —á—Ç–æ–±—ã –æ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ —Å—É—â–Ω–æ—Å—Ç–∏
async function ingestTextWithEntities(){
  const title = document.getElementById('title').value || 'doc';
  const text = document.getElementById('text').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  
  // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
  const fd1 = new FormData(); 
  fd1.append('doc_id', title); 
  fd1.append('text', text);
  const r1 = await fetch(API + '/ingest/text', {method:'POST', body: fd1});
  const j1 = await r1.json();
  
  // –ó–∞—Ç–µ–º –∏–∑–≤–ª–µ–∫–∞–µ–º —Å—É—â–Ω–æ—Å—Ç–∏
  const fd2 = new FormData(); 
  fd2.append('text', text); 
  fd2.append('task_prompt', document.getElementById('lx_prompt').value || ''); 
  fd2.append('doc_id', title);
  const r2 = await fetch(API + '/langextract/text', {method:'POST', body: fd2}); 
  const j2 = await r2.json();
  
  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—É—â–Ω–æ—Å—Ç–∏
  displayEntities(j2.items || []);
  
  alert(`‚úÖ –î–æ–∫—É–º–µ–Ω—Ç "${title}" –¥–æ–±–∞–≤–ª–µ–Ω!\nüîç –ò–∑–≤–ª–µ—á–µ–Ω–æ ${j2.items ? j2.items.length : 0} —Å—É—â–Ω–æ—Å—Ç–µ–π`);
}

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é runLEText —á—Ç–æ–±—ã –æ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ —Å—É—â–Ω–æ—Å—Ç–∏
async function runLETextWithDisplay(){
  const text = document.getElementById('lx_text').value || ''; 
  const prompt = document.getElementById('lx_prompt').value || '';
  if(!text.trim()) return alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç');
  
  const fd = new FormData(); 
  fd.append('text', text); 
  fd.append('task_prompt', prompt); 
  fd.append('doc_id','demo_doc');
  const r = await fetch(API + '/langextract/text', {method:'POST', body: fd}); 
  const j = await r.json();
  
  document.getElementById('lx_out').textContent = JSON.stringify(j.items.slice(0,20), null, 2);
  displayEntities(j.items || []);
  window.open(API + '/extracts/' + j.job_id + '/viz.html', '_blank');
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º API
function showVersionInfo() {
  const now = new Date();
  const buildTime = now.toLocaleString('ru-RU');
  document.getElementById('buildInfo').textContent = `Build: AUTO-UPDATE-20250904${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  const header = document.querySelector('header');
  const updateBadge = document.createElement('div');
  updateBadge.className = 'fixed top-4 right-4 bg-emerald-500 text-white px-3 py-1 rounded-full text-xs font-medium shadow-lg z-50 animate-pulse';
  updateBadge.textContent = 'üÜï –û–±–Ω–æ–≤–ª–µ–Ω–æ!';
  document.body.appendChild(updateBadge);
  
  // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    updateBadge.style.opacity = '0';
    updateBadge.style.transition = 'opacity 1s';
    setTimeout(() => updateBadge.remove(), 1000);
  }, 5000);
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
async function checkAPIStatus() {
  try {
    const response = await fetch(API + '/health');
    const data = await response.json();
    if (data.ok) {
      console.log('‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω, –º–æ–¥–µ–ª—å:', data.model || 'unknown');
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤ header
      const statusDiv = document.createElement('div');
      statusDiv.className = 'text-xs text-emerald-600';
      statusDiv.innerHTML = `üü¢ API Online | Model: ${data.model || 'unknown'}`;
      document.getElementById('apiBase').parentElement.appendChild(statusDiv);
    }
  } catch (error) {
    console.log('‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error.message);
    const statusDiv = document.createElement('div');
    statusDiv.className = 'text-xs text-red-600';
    statusDiv.innerHTML = 'üî¥ API Offline';
    document.getElementById('apiBase').parentElement.appendChild(statusDiv);
  }
}

// === AGENTIC RAG FUNCTIONS ===

function updateModeDescription() {
  // –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ Agentic RAG
  const description = document.getElementById('modeDescription');
  description.innerHTML = 'Agentic: –£–º–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã –ø–ª–∞–Ω–∏—Ä—É—é—Ç, –∏—â—É—Ç –∏ —Å–∏–Ω—Ç–µ–∑–∏—Ä—É—é—Ç –æ—Ç–≤–µ—Ç (–º–µ–¥–ª–µ–Ω–Ω–æ, –Ω–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ)';
}

async function askIntelligent() {
  // –¢–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º Agentic RAG
  await askAgentic();
}

async function askAgentic() {
  const q = document.getElementById('q').value.trim();
  if (!q) {
    alert('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å');
    return;
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤
  const processDiv = document.getElementById('agenticProcess');
  const stepsDiv = document.getElementById('agentSteps');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  
  processDiv.classList.remove('hidden');
  stepsDiv.innerHTML = '';
  progressBar.style.width = '0%';
  progressText.textContent = '0%';
  
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  document.getElementById('plan').textContent = '';
  document.getElementById('answer').innerHTML = '';
  document.getElementById('critique').textContent = '';
  document.getElementById('cites').innerHTML = '';
  document.getElementById('hits').innerHTML = '';
  
  try {
    const url = `${API}/ask/agentic/stream?q=${encodeURIComponent(q)}&max_iterations=5`;
    const eventSource = new EventSource(url);
    
    let currentStep = 0;
    const totalSteps = 5; // Router, Retrieval, Evaluation, Query Rewrite, Synthesis
    
    eventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);
        console.log('Agentic event:', data);
        
        switch(data.type) {
          case 'agentic_start':
            addAgentStep('üöÄ –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã', `–ú–∞–∫—Å–∏–º—É–º –∏—Ç–µ—Ä–∞—Ü–∏–π: ${data.data.max_iterations}`, 'text-blue-600');
            updateProgress(10);
            break;
            
          case 'iteration_start':
            addAgentStep(`üîÑ –ò—Ç–µ—Ä–∞—Ü–∏—è ${data.data.iteration}`, `–ó–∞–ø—Ä–æ—Å: "${data.data.current_query.substring(0, 50)}..."`, 'text-purple-600');
            updateProgress(20 + (data.data.iteration - 1) * 15);
            break;
            
          case 'strategy_selected':
            addAgentStep('üéØ Router Agent', `–í—ã–±—Ä–∞–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: ${data.data.strategy}`, 'text-green-600');
            break;
            
          case 'search_completed':
            const searchData = data.data;
            addAgentStep('üîç Retrieval Agent', 
              `${searchData.strategy}: ${searchData.results_count} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${(searchData.relevance_score * 100).toFixed(1)}%`, 
              'text-indigo-600');
            break;
            
          case 'evaluation':
            const evalData = data.data;
            const evalColor = evalData.decision === 'sufficient' ? 'text-green-600' : 'text-orange-600';
            addAgentStep('üìä Evaluation Agent', `–†–µ—à–µ–Ω–∏–µ: ${evalData.decision} - ${evalData.reason}`, evalColor);
            break;
            
          case 'query_rewritten':
            addAgentStep('‚úèÔ∏è Query Rewriter', `–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: "${data.data.new_query.substring(0, 50)}..."`, 'text-yellow-600');
            break;
            
          case 'synthesis_start':
            addAgentStep('üîÑ Synthesis Agent', `–°–∏–Ω—Ç–µ–∑ –æ—Ç–≤–µ—Ç–∞ –∏–∑ ${data.data.total_results} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤`, 'text-blue-600');
            updateProgress(85);
            break;
            
          case 'agentic_complete':
            const result = data.data;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            document.getElementById('answer').innerHTML = result.answer || '–û—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω';
            
            if (result.citations) {
              const citesList = document.getElementById('cites');
              result.citations.forEach(cite => {
                const li = document.createElement('li');
                li.textContent = cite;
                citesList.appendChild(li);
              });
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
            if (result.agentic_metadata) {
              const metadata = result.agentic_metadata;
              addAgentStep('üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–æ', 
                `–í—Ä–µ–º—è: ${metadata.total_time.toFixed(1)}—Å, –∏—Ç–µ—Ä–∞—Ü–∏–π: ${metadata.iterations_used}, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ${metadata.strategies_tried.join(', ')}`, 
                'text-green-700 font-medium');
            }
            
            updateProgress(100);
            eventSource.close();
            break;
            
          case 'agentic_error':
            addAgentStep('‚ùå –û—à–∏–±–∫–∞', data.data, 'text-red-600');
            eventSource.close();
            break;
        }
      } catch (e) {
        console.error('Error parsing agentic event:', e);
      }
    };
    
    eventSource.onerror = function(event) {
      console.error('Agentic EventSource error:', event);
      addAgentStep('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', '–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'text-red-600');
      eventSource.close();
    };
    
  } catch (error) {
    console.error('Agentic RAG error:', error);
    addAgentStep('‚ùå –û—à–∏–±–∫–∞', error.message, 'text-red-600');
  }
}

function addAgentStep(title, description, colorClass) {
  const stepsDiv = document.getElementById('agentSteps');
  const stepDiv = document.createElement('div');
  stepDiv.className = `flex items-start space-x-2 p-2 rounded ${colorClass} bg-white border-l-4 border-current`;
  stepDiv.innerHTML = `
    <div class="flex-1">
      <div class="font-medium text-sm">${title}</div>
      <div class="text-xs opacity-75">${description}</div>
    </div>
    <div class="text-xs opacity-50">${new Date().toLocaleTimeString()}</div>
  `;
  stepsDiv.appendChild(stepDiv);
  
  // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —à–∞–≥—É
  stepDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function updateProgress(percentage) {
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  
  progressBar.style.width = `${percentage}%`;
  progressText.textContent = `${Math.round(percentage)}%`;
}

// === LANGEXTRACT ANIMATION FUNCTIONS ===

let langextractTimer = null;
let langextractStartTime = null;

async function runLETextWithAnimation() {
  const text = document.getElementById('lx_text').value.trim();
  if (!text) {
    alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è');
    return;
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
  showLangExtractProgress();
  
  try {
    const prompt = document.getElementById('lx_prompt').value.trim();
    const form = new FormData();
    form.append('text', text);
    if (prompt) form.append('task_prompt', prompt);
    
    const response = await fetch(API + '/langextract/text', { method: 'POST', body: form });
    const result = await response.json();
    
    if (response.ok) {
      // –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
      updateLangExtractProgress(100, '–ó–∞–≤–µ—Ä—à–µ–Ω–æ! –ù–∞–π–¥–µ–Ω–æ —Å—É—â–Ω–æ—Å—Ç–µ–π: ' + result.items.length);
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      displayExtractedEntities(result.items);
      
      setTimeout(() => hideLangExtractProgress(), 2000);
    } else {
      throw new Error(result.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    }
  } catch (error) {
    console.error('LangExtract error:', error);
    updateLangExtractProgress(0, '–û—à–∏–±–∫–∞: ' + error.message, true);
    setTimeout(() => hideLangExtractProgress(), 3000);
  }
}

function showLangExtractProgress() {
  const progressDiv = document.getElementById('langextractProgress');
  const extractBtn = document.getElementById('extractBtn');
  const streamBtn = document.getElementById('streamBtn');
  
  progressDiv.classList.remove('hidden');
  extractBtn.disabled = true;
  streamBtn.disabled = true;
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
  langextractStartTime = Date.now();
  langextractTimer = setInterval(updateLangExtractTimer, 100);
  
  // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
  updateLangExtractProgress(10, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...');
  setTimeout(() => updateLangExtractProgress(30, '–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞...'), 500);
  setTimeout(() => updateLangExtractProgress(60, '–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π...'), 1500);
}

function updateLangExtractProgress(percentage, status, isError = false) {
  const bar = document.getElementById('langextractBar');
  const statusDiv = document.getElementById('langextractStatus');
  
  bar.style.width = percentage + '%';
  statusDiv.textContent = status;
  
  if (isError) {
    bar.classList.remove('bg-violet-600');
    bar.classList.add('bg-red-600');
    statusDiv.classList.remove('text-violet-600');
    statusDiv.classList.add('text-red-600');
  }
}

function updateLangExtractTimer() {
  if (langextractStartTime) {
    const elapsed = Math.floor((Date.now() - langextractStartTime) / 1000);
    document.getElementById('langextractTimer').textContent = elapsed + 's';
  }
}

function hideLangExtractProgress() {
  const progressDiv = document.getElementById('langextractProgress');
  const extractBtn = document.getElementById('extractBtn');
  const streamBtn = document.getElementById('streamBtn');
  
  progressDiv.classList.add('hidden');
  extractBtn.disabled = false;
  streamBtn.disabled = false;
  
  if (langextractTimer) {
    clearInterval(langextractTimer);
    langextractTimer = null;
    langextractStartTime = null;
  }
  
  // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π
  const bar = document.getElementById('langextractBar');
  const statusDiv = document.getElementById('langextractStatus');
  bar.style.width = '0%';
  bar.classList.remove('bg-red-600');
  bar.classList.add('bg-violet-600');
  statusDiv.classList.remove('text-red-600');
  statusDiv.classList.add('text-violet-600');
}

// === DOCUMENTS LIST FUNCTIONS ===

async function loadDocumentsList() {
  const container = document.getElementById('documentsContainer');
  const loading = document.getElementById('documentsLoading');
  const error = document.getElementById('documentsError');
  const list = document.getElementById('documentsList');
  const grid = document.getElementById('documentsGrid');
  const empty = document.getElementById('documentsEmpty');
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  loading.classList.remove('hidden');
  error.classList.add('hidden');
  list.classList.add('hidden');
  
  try {
    const response = await fetch(API + '/documents');
    const documents = await response.json();
    
    if (response.ok) {
      loading.classList.add('hidden');
      list.classList.remove('hidden');
      
      if (documents.length === 0) {
        empty.classList.remove('hidden');
        grid.innerHTML = '';
      } else {
        empty.classList.add('hidden');
        displayDocuments(documents);
      }
    } else {
      throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤');
    }
  } catch (err) {
    console.error('Documents loading error:', err);
    loading.classList.add('hidden');
    error.classList.remove('hidden');
    document.getElementById('documentsErrorText').textContent = err.message;
  }
}

function displayDocuments(documents) {
  const grid = document.getElementById('documentsGrid');
  
  grid.innerHTML = documents.map(doc => `
    <div class="border border-slate-200 rounded-lg p-3 hover:bg-slate-50 transition-colors">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium text-sm truncate flex-1 mr-2">${doc.doc_id}</div>
        <button class="text-red-600 hover:text-red-700 text-xs px-2 py-1 rounded hover:bg-red-50 transition-colors" 
                onclick="deleteDocument('${doc.doc_id}')" title="–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç">
          üóëÔ∏è
        </button>
      </div>
      <div class="text-xs text-slate-600 mb-2">${doc.text_preview}</div>
      <div class="flex items-center justify-between text-xs text-slate-500">
        <span>üìÑ ${doc.text_length.toLocaleString()} —Å–∏–º–≤–æ–ª–æ–≤</span>
        <span>üïê –ó–∞–≥—Ä—É–∂–µ–Ω</span>
      </div>
    </div>
  `).join('');
}

async function deleteDocument(docId) {
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç "${docId}"?`)) {
    return;
  }
  
  try {
    const response = await fetch(`${API}/documents/${encodeURIComponent(docId)}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      await loadDocumentsList();
      alert('–î–æ–∫—É–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω');
    } else {
      const error = await response.json();
      throw new Error(error.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }
  } catch (err) {
    console.error('Delete error:', err);
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
  }
}

// === LANGEXTRACT TABS FUNCTIONS ===

function switchLangExtractTab(tabName) {
  // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
  document.getElementById('tabStatus').className = 'px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700';
  document.getElementById('tabText').className = 'px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700';
  document.getElementById('tabResults').className = 'px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700';
  
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫
  document.getElementById('statusTab').classList.add('hidden');
  document.getElementById('textTab').classList.add('hidden');
  document.getElementById('resultsTab').classList.add('hidden');
  
  // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  if (tabName === 'status') {
    document.getElementById('tabStatus').className = 'px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600';
    document.getElementById('statusTab').classList.remove('hidden');
  } else if (tabName === 'text') {
    document.getElementById('tabText').className = 'px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600';
    document.getElementById('textTab').classList.remove('hidden');
  } else if (tabName === 'results') {
    document.getElementById('tabResults').className = 'px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600';
    document.getElementById('resultsTab').classList.remove('hidden');
  }
}

// === FILE LOADING FOR LANGEXTRACT ===

async function loadFileForLangExtract() {
  const fileInput = document.getElementById('lx_file');
  const file = fileInput.files[0];
  
  if (!file) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
    return;
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
  showLangExtractProgress();
  updateLangExtractProgress(20, '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...');
  
  try {
    let text = '';
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ
    if (file.type === 'application/pdf') {
      text = await extractTextFromPDF(file);
    } else if (file.type.includes('json')) {
      text = await extractTextFromJSON(file);
    } else if (file.type.includes('csv')) {
      text = await extractTextFromCSV(file);
    } else if (file.type.includes('xml') || file.type.includes('html')) {
      text = await extractTextFromHTML(file);
    } else if (file.type.includes('word') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
      text = await extractTextFromWord(file);
    } else {
      // –î–ª—è –æ–±—ã—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
      text = await file.text();
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—Å—Ç –≤–æ –≤–∫–ª–∞–¥–∫–µ "–¢–µ–∫—Å—Ç"
    document.getElementById('loadedText').textContent = text;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º textarea –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
    document.getElementById('lx_text').value = text;
    
    updateLangExtractProgress(50, '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–∑–≤–ª–µ–∫–∞–µ–º —Å—É—â–Ω–æ—Å—Ç–∏...');
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–¢–µ–∫—Å—Ç" —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    switchLangExtractTab('text');
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π
    await runLETextWithAnimation();
    
  } catch (error) {
    console.error('File loading error:', error);
    updateLangExtractProgress(0, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message, true);
    setTimeout(() => hideLangExtractProgress(), 3000);
  }
}

async function extractTextFromPDF(file) {
  // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ PDF —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
  try {
    // –î–ª—è PDF —Ñ–∞–π–ª–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
    const userChoice = confirm(
      '‚ö†Ô∏è PDF —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –ø–∞—Ä—Å–∏—Ç—å—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.\n\n' +
      '‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:\n' +
      '1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å PDF –≤ TXT –æ–Ω–ª–∞–π–Ω\n' +
      '2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é\n\n' +
      '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ PDF?'
    );
    
    if (!userChoice) {
      throw new Error('–ó–∞–≥—Ä—É–∑–∫–∞ PDF –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
    }
    
    // –ü—Ä–æ–±—É–µ–º –±–∞–∑–æ–≤–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ
    const arrayBuffer = await file.arrayBuffer();
    const uint8Array = new Uint8Array(arrayBuffer);
    
    // –ò—â–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ –≤ PDF
    let text = '';
    let textFound = false;
    
    // –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –≤ PDF
    for (let i = 0; i < uint8Array.length - 10; i++) {
      // –ò—â–µ–º –º–∞—Ä–∫–µ—Ä—ã —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
      if (uint8Array[i] === 66 && uint8Array[i+1] === 84) { // "BT" - Begin Text
        let j = i + 2;
        let textBlock = '';
        
        // –ß–∏—Ç–∞–µ–º –¥–æ "ET" - End Text
        while (j < uint8Array.length - 1 && !(uint8Array[j] === 69 && uint8Array[j+1] === 84)) {
          const char = uint8Array[j];
          if (char >= 32 && char <= 126) { // –ü–µ—á–∞—Ç–Ω—ã–µ ASCII —Å–∏–º–≤–æ–ª—ã
            textBlock += String.fromCharCode(char);
          } else if (char >= 192 && char <= 255) { // –ö–∏—Ä–∏–ª–ª–∏—Ü–∞
            textBlock += String.fromCharCode(char);
          } else if (char === 10 || char === 13) { // –ü–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫
            textBlock += ' ';
          }
          j++;
        }
        
        if (textBlock.trim().length > 10) {
          text += textBlock + ' ';
          textFound = true;
        }
      }
    }
    
    if (!textFound || text.trim().length < 100) {
      // Fallback: –±–∞–∑–æ–≤–æ–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
      const decoder = new TextDecoder('utf-8', { fatal: false });
      const rawText = decoder.decode(uint8Array);
      
      // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Ç–∞–µ–º—ã–µ —á–∞—Å—Ç–∏
      const cleanText = rawText
        .replace(/[\x00-\x1F\x7F-\x9F]/g, ' ') // –£–±–∏—Ä–∞–µ–º —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–∏–º–≤–æ–ª—ã
        .replace(/[^\x20-\x7E\u0400-\u04FF\s]/g, ' ') // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã
        .replace(/\s+/g, ' ') // –°—Ö–ª–æ–ø—ã–≤–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
        .trim();
      
      if (cleanText.length < 100) {
        throw new Error('PDF —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ —Ç–µ–∫—Å—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å PDF –≤ TXT\n2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é');
      }
      
      text = cleanText;
    }
    
    // –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
    text = text.replace(/\s+/g, ' ').trim();
    
    if (text.length < 50) {
      throw new Error('–ò–∑–≤–ª–µ—á–µ–Ω–æ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ —Ç–µ–∫—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.');
    }
    
    return text;
    
  } catch (error) {
    if (error.message.includes('–æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º')) {
      throw error;
    }
    throw new Error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å PDF —Ñ–∞–π–ª.\n\nüîß –†–µ—à–µ–Ω–∏—è:\n1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ PDF –≤ TXT –æ–Ω–ª–∞–π–Ω\n2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤—Ä—É—á–Ω—É—é\n3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π PDF —Ñ–∞–π–ª');
  }
}

// === ENHANCED FILE FORMAT SUPPORT ===

async function extractTextFromJSON(file) {
  try {
    const text = await file.text();
    const jsonData = JSON.parse(text);
    
    // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ JSON
    function extractTextFromObject(obj) {
      let result = '';
      
      if (typeof obj === 'string') {
        return obj + ' ';
      } else if (typeof obj === 'object' && obj !== null) {
        if (Array.isArray(obj)) {
          obj.forEach(item => {
            result += extractTextFromObject(item);
          });
        } else {
          Object.keys(obj).forEach(key => {
            result += key + ': ';
            result += extractTextFromObject(obj[key]);
          });
        }
      } else if (obj !== null && obj !== undefined) {
        result += String(obj) + ' ';
      }
      
      return result;
    }
    
    return extractTextFromObject(jsonData).trim();
  } catch (error) {
    throw new Error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ JSON —Ñ–∞–π–ª–∞: ' + error.message);
  }
}

async function extractTextFromCSV(file) {
  try {
    const text = await file.text();
    const lines = text.split('\n');
    let result = '';
    
    lines.forEach((line, index) => {
      if (line.trim()) {
        // –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—ã–µ –Ω–∞ –ø—Ä–æ–±–µ–ª—ã –∏ —É–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏
        const cleanLine = line.replace(/,/g, ' ').replace(/"/g, '').trim();
        result += cleanLine + '\n';
      }
    });
    
    return result.trim();
  } catch (error) {
    throw new Error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ CSV —Ñ–∞–π–ª–∞: ' + error.message);
  }
}

async function extractTextFromHTML(file) {
  try {
    const text = await file.text();
    
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π DOM —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = text;
    
    // –£–±–∏—Ä–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã –∏ —Å—Ç–∏–ª–∏
    const scripts = tempDiv.querySelectorAll('script, style');
    scripts.forEach(el => el.remove());
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    return tempDiv.textContent || tempDiv.innerText || '';
  } catch (error) {
    throw new Error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTML/XML —Ñ–∞–π–ª–∞: ' + error.message);
  }
}

async function extractTextFromWord(file) {
  // –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Word –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è)
  try {
    const arrayBuffer = await file.arrayBuffer();
    const uint8Array = new Uint8Array(arrayBuffer);
    
    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö
    const userChoice = confirm(
      '‚ö†Ô∏è Word –¥–æ–∫—É–º–µ–Ω—Ç—ã (.doc/.docx) –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.\n\n' +
      '‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:\n' +
      '1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ TXT —Ñ–∞–π–ª\n' +
      '2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é\n\n' +
      '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ Word –¥–æ–∫—É–º–µ–Ω—Ç–∞?'
    );
    
    if (!userChoice) {
      throw new Error('–û–±—Ä–∞–±–æ—Ç–∫–∞ Word –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
    }
    
    // –ü—Ä–æ—Å—Ç–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ –¥–ª—è –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
    let text = '';
    for (let i = 0; i < uint8Array.length; i++) {
      const char = uint8Array[i];
      if (char >= 32 && char <= 126) { // –ü–µ—á–∞—Ç–Ω—ã–µ ASCII
        text += String.fromCharCode(char);
      } else if (char >= 192 && char <= 255) { // –ö–∏—Ä–∏–ª–ª–∏—Ü–∞
        text += String.fromCharCode(char);
      } else if (char === 10 || char === 13) { // –ü–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫
        text += ' ';
      }
    }
    
    // –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    text = text.replace(/[^\w\s\u0400-\u04FF.,!?;:()\-]/g, ' ')
               .replace(/\s+/g, ' ')
               .trim();
    
    if (text.length < 100) {
      throw new Error('–ò–∑–≤–ª–µ—á–µ–Ω–æ –º–∞–ª–æ —Ç–µ–∫—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –∫–∞–∫ TXT —Ñ–∞–π–ª.');
    }
    
    return text;
  } catch (error) {
    if (error.message.includes('–æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º')) {
      throw error;
    }
    throw new Error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å Word –¥–æ–∫—É–º–µ–Ω—Ç.\n\nüîß –†–µ—à–µ–Ω–∏—è:\n1. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ TXT —Ñ–∞–π–ª\n2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤—Ä—É—á–Ω—É—é');
  }
}

// === FIXED SEARCH FUNCTION ===

async function search() {
  const q = document.getElementById('q').value.trim();
  if (!q) {
    alert('–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å');
    return;
  }
  
  try {
    const response = await fetch(`${API}/search?q=${encodeURIComponent(q)}&k=10`);
    const results = await response.json();
    
    if (response.ok) {
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
      const hitsDiv = document.getElementById('hits');
      hitsDiv.innerHTML = '';
      
      if (results.length === 0) {
        hitsDiv.innerHTML = '<li class="text-slate-500">–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</li>';
      } else {
        results.forEach((hit, index) => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>–†–µ–∑—É–ª—å—Ç–∞—Ç ${index + 1}:</strong> ${hit.text ? hit.text.substring(0, 200) + '...' : '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞'}`;
          hitsDiv.appendChild(li);
        });
      }
      
      alert(`–ù–∞–π–¥–µ–Ω–æ ${results.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤`);
    } else {
      throw new Error(results.message || '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
    }
  } catch (error) {
    console.error('Search error:', error);
    alert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message);
  }
}

// === BUSINESS LOGIC: ENTITY-DRIVEN RAG ===

async function refreshKnowledgeAnalytics() {
  try {
    const response = await fetch(API + '/analytics/entities');
    const analytics = await response.json();
    
    if (response.ok) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
      document.getElementById('totalEntities').textContent = analytics.total_entities.toLocaleString();
      document.getElementById('totalDocuments').textContent = analytics.total_documents.toLocaleString();
      document.getElementById('topEntityType').textContent = analytics.top_entity_type;
      
      // –°–æ–∑–¥–∞–µ–º –æ–±–ª–∞–∫–æ —Å—É—â–Ω–æ—Å—Ç–µ–π
      displayEntityCloud(analytics.entity_cloud);
    }
  } catch (error) {
    console.error('Analytics error:', error);
    document.getElementById('knowledgeEntityCloud').innerHTML = 
      '<div class="text-sm text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</div>';
  }
}

function displayEntityCloud(entities) {
  const cloud = document.getElementById('knowledgeEntityCloud');
  
  if (entities.length === 0) {
    cloud.innerHTML = '<div class="text-sm text-slate-500">–°—É—â–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∏–∑–≤–ª–µ–∫–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç–∏.</div>';
    return;
  }
  
  cloud.innerHTML = entities.map(entity => {
    // –†–∞–∑–º–µ—Ä —Ç–µ–≥–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
    const sizeClass = entity.count > 5 ? 'text-base' : entity.count > 2 ? 'text-sm' : 'text-xs';
    const colorClass = getEntityColor(entity.type);
    
    return `
      <button class="px-3 py-1 rounded-full ${colorClass} ${sizeClass} font-medium hover:opacity-80 transition-opacity cursor-pointer"
              onclick="searchByEntity('${entity.text.replace(/'/g, "\\'")}')"
              title="–ù–∞–π–¥–µ–Ω–æ –≤ ${entity.count} –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö">
        ${entity.text} (${entity.count})
      </button>
    `;
  }).join('');
}

function getEntityColor(type) {
  const colors = {
    'person': 'bg-blue-100 text-blue-800 hover:bg-blue-200',
    'organization': 'bg-green-100 text-green-800 hover:bg-green-200',
    'location': 'bg-purple-100 text-purple-800 hover:bg-purple-200',
    'date': 'bg-orange-100 text-orange-800 hover:bg-orange-200',
    'entity': 'bg-slate-100 text-slate-800 hover:bg-slate-200'
  };
  return colors[type] || colors['entity'];
}

async function searchByEntity(entityText) {
  // –î–æ–±–∞–≤–ª—è–µ–º —Å—É—â–Ω–æ—Å—Ç—å –≤ –ø–æ–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞
  const entitiesInput = document.getElementById('entities');
  const currentValue = entitiesInput.value.trim();
  
  if (currentValue) {
    entitiesInput.value = currentValue + ', ' + entityText;
  } else {
    entitiesInput.value = entityText;
  }
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º —É–º–Ω—ã–π –ø–æ–∏—Å–∫
  document.getElementById('q').value = `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ ${entityText}`;
  await askIntelligent();
}

async function showEntitySuggestions() {
  const suggestionsDiv = document.getElementById('entitySuggestions');
  const cloudDiv = document.getElementById('entityCloud');
  
  suggestionsDiv.classList.remove('hidden');
  cloudDiv.innerHTML = '<div class="text-sm text-blue-600">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  
  try {
    const response = await fetch(API + '/analytics/entities');
    const analytics = await response.json();
    
    if (response.ok && analytics.entity_cloud.length > 0) {
      cloudDiv.innerHTML = analytics.entity_cloud.slice(0, 20).map(entity => `
        <button class="px-2 py-1 rounded bg-blue-100 text-blue-800 text-xs hover:bg-blue-200 transition-colors"
                onclick="addEntityToFilter('${entity.text.replace(/'/g, "\\'")}')">
          ${entity.text}
        </button>
      `).join('');
    } else {
      cloudDiv.innerHTML = '<div class="text-sm text-blue-600">–°—É—â–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∏–∑–≤–ª–µ–∫–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç–∏.</div>';
    }
  } catch (error) {
    cloudDiv.innerHTML = '<div class="text-sm text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π</div>';
  }
}

function hideEntitySuggestions() {
  document.getElementById('entitySuggestions').classList.add('hidden');
}

function addEntityToFilter(entityText) {
  const entitiesInput = document.getElementById('entities');
  const currentValue = entitiesInput.value.trim();
  
  if (currentValue) {
    entitiesInput.value = currentValue + ', ' + entityText;
  } else {
    entitiesInput.value = entityText;
  }
  
  hideEntitySuggestions();
}

async function searchByEntities() {
  const entities = document.getElementById('entities').value.trim();
  if (!entities) {
    alert('–í–≤–µ–¥–∏—Ç–µ —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞');
    return;
  }
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º —É–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–Ω–æ—Å—Ç–µ–π
  const query = `–ù–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å–≤—è–∑–∞–Ω–Ω—É—é —Å: ${entities}`;
  document.getElementById('q').value = query;
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º Agentic RAG —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ —Å—É—â–Ω–æ—Å—Ç–∏
  await askIntelligent();
}

// === ENHANCED LANGEXTRACT INTEGRATION ===

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
const originalRunLETextWithAnimation = runLETextWithAnimation;
runLETextWithAnimation = async function() {
  await originalRunLETextWithAnimation();
  
  // –ü–æ—Å–ª–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π –æ–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É
  setTimeout(refreshKnowledgeAnalytics, 1000);
};

// === IMPROVED FILE UPLOAD WITH FEEDBACK ===

async function ingestFilesWithFeedback() {
  const fileInput = document.getElementById('files');
  const files = fileInput.files;
  
  if (!files || files.length === 0) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
    return;
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
  const button = event.target;
  const originalText = button.textContent;
  button.disabled = true;
  button.textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º...';
  
  try {
    const formData = new FormData();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
    for (let i = 0; i < files.length; i++) {
      formData.append('files', files[i]);
    }
    
    const response = await fetch(API + '/ingest/files', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (response.ok) {
      // –£—Å–ø–µ—Ö
      alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${result.count} —Ñ–∞–π–ª–æ–≤!\n\n–§–∞–π–ª—ã: ${result.files.join(', ')}\n\n–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –∏—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —á–µ—Ä–µ–∑ Agentic RAG.`);
      
      // –û—á–∏—â–∞–µ–º input
      fileInput.value = '';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫—É
      setTimeout(() => {
        loadDocumentsList();
        refreshKnowledgeAnalytics();
      }, 1000);
      
    } else {
      throw new Error(result.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤');
    }
    
  } catch (error) {
    console.error('File upload error:', error);
    alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:\n\n' + error.message + '\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–æ–≤ (txt, md, pdf)\n2. –£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤\n3. –ó–∞–≥—Ä—É–∂–∞—Ç—å –ø–æ –æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É');
  } finally {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
    button.disabled = false;
    button.textContent = originalText;
  }
}

// === ENHANCED TEXT INGESTION ===

async function ingestTextWithEntities() {
  const title = document.getElementById('title').value.trim();
  const text = document.getElementById('text').value.trim();
  
  if (!text) {
    alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
    return;
  }
  
  const button = event.target;
  const originalText = button.textContent;
  button.disabled = true;
  button.textContent = '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...';
  
  try {
    // 1. –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –±–∞–∑—É
    const formData = new FormData();
    formData.append('text', text);
    if (title) formData.append('doc_id', title);
    
    const ingestResponse = await fetch(API + '/ingest/text', {
      method: 'POST',
      body: formData
    });
    
    const ingestResult = await ingestResponse.json();
    
    if (!ingestResponse.ok) {
      throw new Error(ingestResult.message || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞');
    }
    
    // 2. –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—É—â–Ω–æ—Å—Ç–∏
    const extractFormData = new FormData();
    extractFormData.append('text', text);
    extractFormData.append('task_prompt', '–ò–∑–≤–ª–µ–∫–∏ –ª—é–¥–µ–π, –∫–æ–º–ø–∞–Ω–∏–∏, –º–µ—Å—Ç–∞, —Å–æ–±—ã—Ç–∏—è –∏ –¥–∞—Ç—ã –∏–∑ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞');
    
    const extractResponse = await fetch(API + '/langextract/text', {
      method: 'POST',
      body: extractFormData
    });
    
    const extractResult = await extractResponse.json();
    
    if (extractResponse.ok) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      displayExtractedEntities(extractResult.items);
      
      alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!\n\nüìÑ –î–æ–∫—É–º–µ–Ω—Ç: ${ingestResult.doc_id}\nüè∑Ô∏è –ò–∑–≤–ª–µ—á–µ–Ω–æ —Å—É—â–Ω–æ—Å—Ç–µ–π: ${extractResult.items.length}\n\n–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –∏—Å–∫–∞—Ç—å –ø–æ —ç—Ç–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É —á–µ—Ä–µ–∑ Agentic RAG.`);
      
      // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
      document.getElementById('title').value = '';
      document.getElementById('text').value = '';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É
      setTimeout(() => {
        loadDocumentsList();
        refreshKnowledgeAnalytics();
      }, 1000);
      
    } else {
      // –¢–µ–∫—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω, –Ω–æ —Å—É—â–Ω–æ—Å—Ç–∏ –Ω–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã
      alert(`‚úÖ –¢–µ–∫—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ "${ingestResult.doc_id}"\n‚ö†Ô∏è –°—É—â–Ω–æ—Å—Ç–∏ –Ω–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã: ${extractResult.message}\n\n–ú–æ–∂–µ—Ç–µ –∏—Å–∫–∞—Ç—å –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É —á–µ—Ä–µ–∑ RAG.`);
    }
    
  } catch (error) {
    console.error('Text ingestion error:', error);
    alert('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:\n\n' + error.message);
  } finally {
    button.disabled = false;
    button.textContent = originalText;
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
showVersionInfo();
checkAPIStatus();
updateModeDescription();
loadDocumentsList();
refreshKnowledgeAnalytics();
</script>

<!-- –°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
<section class="mt-6 bg-white rounded-2xl shadow p-4">
  <div class="flex items-center justify-between mb-4">
    <h2 class="font-semibold">üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h2>
    <button class="px-3 py-1 rounded bg-slate-600 text-white text-xs hover:bg-slate-700 transition-colors" onclick="loadDocumentsList()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>
  
  <div id="documentsContainer">
    <div id="documentsLoading" class="flex items-center justify-center py-8 text-slate-500">
      <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-slate-600 mr-2"></div>
      –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...
    </div>
    
    <div id="documentsError" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
      <div class="text-red-700 font-medium">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
      <div class="text-red-600 text-sm mt-1" id="documentsErrorText"></div>
    </div>
    
    <div id="documentsList" class="hidden">
      <div class="grid gap-3" id="documentsGrid"></div>
      <div id="documentsEmpty" class="hidden text-center py-8 text-slate-500">
        üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –≤—ã—à–µ!
      </div>
    </div>
  </div>
</section>

</body>
</html>
