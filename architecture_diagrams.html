<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiAgent-RAG Pro - Architecture Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1e293b;
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5rem;
        }
        h2 {
            color: #334155;
            margin-top: 50px;
            margin-bottom: 20px;
            font-size: 1.8rem;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 10px;
        }
        .diagram-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .download-btn {
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .download-btn:hover {
            background: #2563eb;
        }
        .description {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèóÔ∏è MultiAgent-RAG Pro<br>Architecture Diagrams</h1>
        
        <div class="description">
            <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é:</strong><br>
            ‚Ä¢ –ö–ª–∏–∫–Ω–∏—Ç–µ –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –ø–æ –¥–∏–∞–≥—Ä–∞–º–º–µ ‚Üí "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫..."<br>
            ‚Ä¢ –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ "–°–∫–∞—á–∞—Ç—å PNG" –ø–æ–¥ –∫–∞–∂–¥–æ–π –¥–∏–∞–≥—Ä–∞–º–º–æ–π
        </div>

        <h2>1. –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã</h2>
        <div class="description">
            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: Frontend (GitHub Pages), Backend (Railway), Multi-Agent —Å–∏—Å—Ç–µ–º—É, Hybrid –ø–æ–∏—Å–∫ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å OpenAI API.
        </div>
        <div class="diagram-container">
            <div class="mermaid" id="diagram1">
graph TB
    %% Frontend Layer
    subgraph "üåê Frontend (GitHub Pages)"
        UI["`**MultiAgent-RAG Pro UI**
        - HTML/JavaScript/TailwindCSS
        - –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π
        - RAG-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å`"]
    end

    %% Backend Services
    subgraph "‚òÅÔ∏è Backend (Railway)"
        subgraph "üöÄ FastAPI Server"
            API["`**main.py**
            - REST API endpoints
            - CORS middleware
            - SSE streaming`"]
            
            subgraph "ü§ñ Multi-Agent System"
                PLANNER["`**Planner Agent**
                –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å
                –°–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–∞–Ω`"]
                
                WRITER["`**Writer Agent**
                –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç
                –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç`"]
                
                CRITIC["`**Critic Agent**
                –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ
                –£–ª—É—á—à–∞–µ—Ç –æ—Ç–≤–µ—Ç`"]
            end
            
            subgraph "üîç Retrieval System"
                HYBRID["`**HybridCorpus**
                - BM25 (sparse search)
                - FAISS (vector search)
                - RRF ranking fusion`"]
                
                RERANK["`**LLM Reranker**
                Post-processing
                —Å GPT-5-mini`"]
            end
            
            subgraph "üìä Entity Extraction"
                LANGX["`**LangExtract**
                - Named Entity Recognition
                - GPT-5-mini powered
                - Organizations, Persons, Dates, Money`"]
            end
        end
    end

    %% External Services
    subgraph "üîó External APIs"
        OPENAI["`**OpenAI API**
        - GPT-5-mini (LLM)
        - text-embedding-3-small
        - API Key authentication`"]
    end

    %% Data Storage
    subgraph "üíæ Data Layer"
        DOCS["`**Documents Storage**
        - JSON files
        - Full text storage`"]
        
        CHUNKS["`**Chunks Storage**
        - Semantic chunking
        - Max 1500 chars per chunk`"]
        
        FAISS_DB["`**FAISS Index**
        - Vector embeddings
        - Similarity search`"]
        
        BM25_DB["`**BM25 Index**
        - Keyword search
        - TF-IDF scoring`"]
        
        ENTITIES["`**Extracted Entities**
        - JSONL format
        - HTML visualizations`"]
    end

    %% User Interactions
    USER["`üë§ **User**
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã
    –ó–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã`"]

    %% Flow connections
    USER --> UI
    UI --> API
    
    %% Document ingestion flow
    API --> HYBRID
    API --> LANGX
    HYBRID --> CHUNKS
    HYBRID --> FAISS_DB
    HYBRID --> BM25_DB
    LANGX --> ENTITIES
    
    %% Query processing flow
    API --> PLANNER
    PLANNER --> HYBRID
    HYBRID --> RERANK
    RERANK --> WRITER
    WRITER --> CRITIC
    CRITIC --> API
    
    %% External API calls
    LANGX --> OPENAI
    RERANK --> OPENAI
    PLANNER --> OPENAI
    WRITER --> OPENAI
    CRITIC --> OPENAI
    HYBRID --> OPENAI
    
    %% Data persistence
    HYBRID --> DOCS
    LANGX --> ENTITIES

    %% Styling
    classDef frontend fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef backend fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef agents fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef storage fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef external fill:#fff8e1,stroke:#f57f17,stroke-width:2px

    class UI frontend
    class API,HYBRID,RERANK,LANGX backend
    class PLANNER,WRITER,CRITIC agents
    class DOCS,CHUNKS,FAISS_DB,BM25_DB,ENTITIES storage
    class OPENAI external
            </div>
            <button class="download-btn" onclick="downloadDiagram('diagram1', 'architecture-overview')">üì• –°–∫–∞—á–∞—Ç—å PNG</button>
        </div>

        <h2>2. –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h2>
        <div class="description">
            Sequence –¥–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å: –æ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Multi-Agent —Å–∏—Å—Ç–µ–º—ã.
        </div>
        <div class="diagram-container">
            <div class="mermaid" id="diagram2">
sequenceDiagram
    participant U as üë§ User
    participant UI as üåê Frontend
    participant API as üöÄ FastAPI
    participant P as üß† Planner
    participant H as üîç HybridCorpus
    participant R as üéØ LLM Reranker
    participant W as ‚úçÔ∏è Writer
    participant C as üîç Critic
    participant OpenAI as ü§ñ OpenAI API

    Note over U,OpenAI: üìÑ Document Ingestion Flow
    U->>UI: –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
    UI->>API: POST /ingest/text
    API->>H: ingest_text(doc_id, text)
    H->>H: _semantic_chunking(text)
    H->>OpenAI: –°–æ–∑–¥–∞–Ω–∏–µ embeddings
    OpenAI-->>H: Vector embeddings
    H->>H: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ FAISS + BM25
    API->>API: LangExtract –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–µ–π
    API->>OpenAI: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π
    OpenAI-->>API: Extracted entities
    API-->>UI: {doc_id, entities}
    UI-->>U: ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω + —Å—É—â–Ω–æ—Å—Ç–∏

    Note over U,OpenAI: ü§î Query Processing Flow
    U->>UI: –ó–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å
    UI->>API: GET /ask/stream?q=...
    
    API->>P: –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
    P->>OpenAI: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞
    OpenAI-->>P: –ü–ª–∞–Ω –ø–æ–∏—Å–∫–∞
    P-->>API: search_plan
    
    API->>H: search(query, k=10)
    H->>H: BM25 –ø–æ–∏—Å–∫ (sparse)
    H->>OpenAI: –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (dense)
    OpenAI-->>H: –ü–æ—Ö–æ–∂–∏–µ embeddings
    H->>H: RRF —Å–ª–∏—è–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    H-->>API: –¢–æ–ø-10 —á–∞–Ω–∫–æ–≤
    
    API->>R: LLM reranking
    R->>OpenAI: –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    OpenAI-->>R: –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–∏
    R-->>API: –¢–æ–ø-5 —á–∞–Ω–∫–æ–≤
    
    API->>W: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
    W->>OpenAI: –û—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    OpenAI-->>W: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
    W-->>API: draft_answer
    
    API->>C: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞
    C->>OpenAI: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–∞
    OpenAI-->>C: –ö—Ä–∏—Ç–∏–∫–∞ –∏ —É–ª—É—á—à–µ–Ω–∏—è
    C-->>API: final_answer
    
    API-->>UI: SSE stream {plan, answer, critique, citations}
    UI-->>U: üìù –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏

    Note over U,OpenAI: üîç Entity Search Enhancement
    U->>UI: –ö–ª–∏–∫ –ø–æ —Å—É—â–Ω–æ—Å—Ç–∏
    UI->>UI: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Ñ–∏–ª—å—Ç—Ä
    U->>UI: –ü–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º —Å—É—â–Ω–æ—Å—Ç–µ–π
    UI->>API: GET /search?entities=ACME
    API->>H: –§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫
    H-->>API: –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
    API-->>UI: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
    UI-->>U: üéØ –¢–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            </div>
            <button class="download-btn" onclick="downloadDiagram('diagram2', 'data-flow-sequence')">üì• –°–∫–∞—á–∞—Ç—å PNG</button>
        </div>

        <h2>3. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</h2>
        <div class="description">
            –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞ –ø–æ —Å–ª–æ—è–º: Presentation, API, Business Logic, Infrastructure, Data Storage –∏ –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã.
        </div>
        <div class="diagram-container">
            <div class="mermaid" id="diagram3">
graph LR
    subgraph "üèóÔ∏è MultiAgent-RAG Pro Architecture"
        
        subgraph "üì± Presentation Layer"
            HTML["`**index.html**
            - TailwindCSS styling
            - PDF.js integration
            - Entity visualization
            - Real-time updates`"]
        end
        
        subgraph "üîå API Layer"
            MAIN["`**main.py**
            - FastAPI routes
            - CORS handling
            - SSE streaming
            - Error handling`"]
        end
        
        subgraph "üß† Business Logic"
            AGENTS["`**agents.py**
            - Multi-agent orchestration
            - Planner/Writer/Critic
            - Stream processing`"]
            
            RETRIEVAL["`**retrieval.py**
            - HybridCorpus class
            - FAISS + BM25 integration
            - Semantic chunking
            - RRF ranking`"]
            
            LANGX["`**langx.py**
            - LangExtract wrapper
            - Entity extraction
            - Visualization export`"]
        end
        
        subgraph "‚öôÔ∏è Infrastructure"
            LLM["`**llm.py**
            - OpenAI API client
            - Model abstraction
            - Streaming support`"]
            
            CONFIG["`**config.py**
            - Environment variables
            - API key management
            - Model configuration`"]
            
            PROFILES["`**profiles.py**
            - Task templates
            - Prompt management
            - Example datasets`"]
        end
        
        subgraph "üíæ Data Storage"
            JSON_DOCS["`**docs.json**
            Full document texts`"]
            
            FAISS_IDX["`**faiss.index**
            Vector embeddings`"]
            
            CHUNK_MAP["`**chunk_map.json**
            Chunk metadata`"]
            
            EXTRACTS["`**extracts/**
            Entity extractions
            HTML visualizations`"]
        end
        
        subgraph "üåç External Services"
            OPENAI_API["`**OpenAI API**
            - GPT-5-mini
            - text-embedding-3-small
            - Rate limiting`"]
        end
        
        subgraph "‚òÅÔ∏è Deployment"
            GITHUB["`**GitHub Pages**
            Static frontend hosting`"]
            
            RAILWAY["`**Railway**
            Python backend hosting`"]
        end
    end
    
    %% Dependencies
    HTML --> MAIN
    MAIN --> AGENTS
    MAIN --> RETRIEVAL
    MAIN --> LANGX
    
    AGENTS --> LLM
    RETRIEVAL --> LLM
    LANGX --> LLM
    
    LLM --> CONFIG
    AGENTS --> CONFIG
    RETRIEVAL --> CONFIG
    LANGX --> CONFIG
    
    AGENTS --> PROFILES
    
    RETRIEVAL --> JSON_DOCS
    RETRIEVAL --> FAISS_IDX
    RETRIEVAL --> CHUNK_MAP
    LANGX --> EXTRACTS
    
    LLM --> OPENAI_API
    
    HTML -.-> GITHUB
    MAIN -.-> RAILWAY
    
    %% Styling
    classDef presentation fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef api fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef business fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef infra fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef storage fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef external fill:#fff8e1,stroke:#fbc02d,stroke-width:2px
    classDef deploy fill:#f1f8e9,stroke:#689f38,stroke-width:2px
    
    class HTML presentation
    class MAIN api
    class AGENTS,RETRIEVAL,LANGX business
    class LLM,CONFIG,PROFILES infra
    class JSON_DOCS,FAISS_IDX,CHUNK_MAP,EXTRACTS storage
    class OPENAI_API external
    class GITHUB,RAILWAY deploy
            </div>
            <button class="download-btn" onclick="downloadDiagram('diagram3', 'component-architecture')">üì• –°–∫–∞—á–∞—Ç—å PNG</button>
        </div>

        <div class="description" style="margin-top: 40px; background: #dcfce7; border-left-color: #22c55e;">
            <strong>‚úÖ –ì–æ—Ç–æ–≤–æ!</strong> –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ:<br>
            ‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ—Ç HTML —Ñ–∞–π–ª –∏ –æ—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ<br>
            ‚Ä¢ –ö–ª–∏–∫–Ω—É—Ç—å –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –ø–æ –ª—é–±–æ–π –¥–∏–∞–≥—Ä–∞–º–º–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ PNG<br>
            ‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ "–°–∫–∞—á–∞—Ç—å PNG" –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã –∫–∞–∫ PNG
        function downloadDiagram(diagramId, filename) {
            const svg = document.querySelector(`#${diagramId} svg`);
            if (!svg) {
                alert('–î–∏–∞–≥—Ä–∞–º–º–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ SVG –≤ PNG
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const svgData = new XMLSerializer().serializeToString(svg);
            const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
            const svgUrl = URL.createObjectURL(svgBlob);
            
            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                
                // –°–∫–∞—á–∏–≤–∞–µ–º PNG
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `multiagent-rag-${filename}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
                
                URL.revokeObjectURL(svgUrl);
            };
            img.src = svgUrl;
        }
    </script>
</body>
</html>
